<!DOCTYPE html><html lang="de"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>Ultimate Tournament Manager Pro V7.8</title><link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet"><script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script><style>:root{--bg-dark:#0f172a;--bg-panel:rgba(30,41,59,.7);--bg-card:rgba(51,65,85,.6);--accent-primary:#3b82f6;--accent-secondary:#8b5cf6;--accent-glow:#60a5fa;--text-main:#f1f5f9;--text-muted:#94a3b8;--success:#10b981;--danger:#ef4444;--warning:#f59e0b;--gold:#fbbf24;--silver:#cbd5e1;--bronze:#d97706;--border-glass:1px solid rgba(255,255,255,.1);--font-headings:'Rajdhani',sans-serif;--font-body:'Inter',sans-serif}[data-theme=light]{--bg-dark:#f0f2f5;--bg-panel:rgba(255,255,255,.8);--bg-card:#fff;--text-main:#1e293b;--text-muted:#64748b}body{font-family:var(--font-body);background-color:var(--bg-dark);background-image:radial-gradient(at 0% 0%,rgba(59,130,246,.15) 0,transparent 50%),radial-gradient(at 100% 100%,rgba(139,92,246,.15) 0,transparent 50%);background-attachment:fixed;color:var(--text-main);margin:0;padding:0;min-height:100vh;display:flex;flex-direction:column;overflow-x:hidden}header{background:rgba(15,23,42,.8);backdrop-filter:blur(12px);border-bottom:var(--border-glass);padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}h1{font-family:var(--font-headings);font-weight:700;text-transform:uppercase;letter-spacing:2px;font-size:1.5rem;margin:0;background:linear-gradient(to right,var(--accent-primary),var(--accent-secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}nav{display:flex;gap:8px;background:rgba(0,0,0,.2);padding:5px;border-radius:12px}.nav-btn{background:0 0;border:none;color:var(--text-muted);padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600;font-family:var(--font-headings);text-transform:uppercase;transition:all .3s ease}.nav-btn:hover{color:var(--text-main);background:rgba(255,255,255,.05)}.nav-btn.active{color:#fff;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));box-shadow:0 0 15px rgba(59,130,246,.4)}.container{flex:1;padding:20px;max-width:1600px;margin:0 auto;width:100%;box-sizing:border-box}.view-section{display:none;opacity:0;transform:translateY(10px);transition:opacity .4s ease,transform .4s ease}.view-section.active{display:block;opacity:1;transform:translateY(0)}.panel{background:var(--bg-panel);backdrop-filter:blur(16px);border:var(--border-glass);border-radius:16px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.2);margin-bottom:24px;position:relative;overflow:hidden}.panel::before{content:'';position:absolute;top:0;left:0;width:100%;height:2px;background:linear-gradient(90deg,transparent,var(--accent-primary),transparent)}.panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:1px solid rgba(255,255,255,.05);padding-bottom:15px}.panel h2{margin:0;font-family:var(--font-headings);font-size:1.4rem;color:var(--text-main)}input,select{width:100%;padding:12px 15px;border-radius:8px;border:1px solid rgba(255,255,255,.1);background:rgba(0,0,0,.3);color:var(--text-main);font-family:var(--font-body);font-size:.95rem;transition:all .2s;box-sizing:border-box}input:focus,select:focus{outline:0;border-color:var(--accent-primary);box-shadow:0 0 0 3px rgba(59,130,246,.2);background:rgba(0,0,0,.4)}input[type=date],input[type=datetime-local],input[type=time]{color-scheme:dark}.btn{width:100%;padding:12px;border:none;border-radius:8px;font-weight:700;cursor:pointer;text-transform:uppercase;font-family:var(--font-headings);letter-spacing:1px;transition:all .3s;margin-top:10px;display:flex;align-items:center;justify-content:center;gap:8px}.btn-primary{background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));color:#fff;box-shadow:0 4px 15px rgba(59,130,246,.3)}.btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(59,130,246,.5)}.btn-secondary{background:rgba(255,255,255,.1);color:var(--text-main);border:1px solid rgba(255,255,255,.1)}.btn-secondary:hover{background:rgba(255,255,255,.15)}.btn-danger{background:rgba(239,68,68,.2);color:var(--danger);border:1px solid rgba(239,68,68,.3)}.btn-warning{background:rgba(245,158,11,.2);color:var(--warning);border:1px solid var(--warning)}.btn-warning:hover{background:rgba(245,158,11,.3);box-shadow:0 0 10px rgba(245,158,11,.3)}.file-label{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;border:2px dashed rgba(255,255,255,.2);border-radius:12px;cursor:pointer;transition:all .2s;background:rgba(0,0,0,.1);text-align:center}.file-label:hover{border-color:var(--accent-primary);background:rgba(59,130,246,.05)}.file-label input{display:none}.participant-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:15px;max-height:400px;overflow-y:auto;padding-right:5px;margin-top:15px}.p-card{background:var(--bg-card);border:1px solid rgba(255,255,255,.05);border-radius:10px;padding:12px;display:flex;align-items:center;gap:15px;transition:transform .2s}.p-card:hover{transform:translateY(-2px);border-color:rgba(255,255,255,.2)}.p-img-wrapper{position:relative;width:60px;height:60px;flex-shrink:0;cursor:pointer}.p-img{width:100%;height:100%;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,.2);transition:all .2s}.p-img-edit-overlay{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:50%;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;font-size:1.2rem;opacity:0;transition:opacity .2s}.p-img-wrapper:hover .p-img-edit-overlay{opacity:1}.p-name-input{background:0 0;border:none;border-bottom:1px solid transparent;color:var(--text-main);font-weight:600;font-size:1.1rem;width:100%}.p-name-input:focus{outline:0;border-bottom:1px solid var(--accent-primary)}.groups-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:24px}.group-card{background:var(--bg-card);border-radius:16px;overflow:hidden;box-shadow:0 4px 6px rgba(0,0,0,.1);border:var(--border-glass)}.group-header{background:linear-gradient(90deg,rgba(59,130,246,.2),transparent);padding:12px 20px;font-family:var(--font-headings);font-weight:700;font-size:1.2rem;color:var(--accent-glow);border-bottom:1px solid rgba(255,255,255,.05)}.group-table{width:100%;border-collapse:collapse;font-size:.9rem}.group-table th{text-align:left;color:var(--text-muted);padding:10px 15px;font-size:.75rem;text-transform:uppercase;letter-spacing:1px}.group-table td{padding:12px 15px;border-bottom:1px solid rgba(255,255,255,.05)}.rank-advancing{background:linear-gradient(90deg,rgba(16,185,129,.1),transparent);border-left:3px solid var(--success)}.bracket-wrapper{display:flex;justify-content:center;align-items:center;overflow:hidden;padding:20px;height:calc(100vh - 200px);position:relative;z-index:5;width:100%}.round-col{display:flex;flex-direction:column;justify-content:space-around;min-width:260px;margin:0 25px;position:relative;z-index:10;transition:z-index 0s}.round-header{text-align:center;font-family:var(--font-headings);text-transform:uppercase;color:var(--text-muted);font-weight:700;letter-spacing:2px;margin-bottom:15px;font-size:.9rem}.match-card{background:rgba(30,41,59,.9);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:0;position:relative;transition:all .3s cubic-bezier(.4,0,.2,1);width:260px;margin:10px 0;box-shadow:0 4px 6px rgba(0,0,0,.2);cursor:pointer;z-index:1}.match-card:hover{transform:scale(1.02);border-color:var(--accent-primary);box-shadow:0 0 20px rgba(59,130,246,.4);z-index:1000}.match-vs{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#0f172a;border:1px solid rgba(255,255,255,.2);color:var(--text-muted);font-size:.6rem;font-weight:700;padding:2px 5px;border-radius:4px;z-index:5}.match-team{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;height:36px;border-bottom:1px solid rgba(255,255,255,.05);position:relative;overflow:hidden}.match-team:last-child{border-bottom:none}.match-team.winner{background:linear-gradient(90deg,rgba(16,185,129,.2),transparent)}.match-team.winner .team-name{color:var(--success);font-weight:700;text-shadow:0 0 10px rgba(16,185,129,.5)}.match-team.winner .team-score{background:rgba(0,0,0,.3);color:inherit;box-shadow:none}.match-card.trace-active{border-color:var(--gold);box-shadow:0 0 15px rgba(251,191,36,.4)}.match-team.trace-team{background:linear-gradient(90deg,rgba(251,191,36,.2),transparent)}.team-info{display:flex;align-items:center;gap:10px;flex:1;overflow:hidden}.team-img{width:32px;height:32px;border-radius:50%;background:#333;object-fit:cover;flex-shrink:0;border:1px solid rgba(255,255,255,.2)}.team-name{font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.team-score{font-family:'Rajdhani',monospace;font-size:1.1rem;font-weight:700;background:rgba(0,0,0,.3);padding:2px 8px;border-radius:4px;min-width:20px;text-align:center}.match-card *{pointer-events:none}.match-card .team-name,.match-card .team-score{pointer-events:auto}.champion-icon{position:absolute;top:-25px;left:50%;transform:translateX(-50%);font-size:2rem;filter:drop-shadow(0 0 10px gold);animation:float 3s infinite ease-in-out;display:none}.has-champion .champion-icon{display:block}@keyframes float{0%,100%{transform:translate(-50%,0)}50%{transform:translate(-50%,-10px)}}.leaderboard-container{display:flex;flex-direction:column;gap:10px;margin-bottom:30px}.leaderboard-row{display:flex;align-items:center;background:var(--bg-card);border:1px solid rgba(255,255,255,.05);border-radius:12px;padding:15px;position:relative;overflow:hidden}.leaderboard-row.qualified{background:linear-gradient(90deg,rgba(16,185,129,.15),rgba(30,41,59,.8));border-left:4px solid var(--success)}.leaderboard-row.relegation-tie{background:linear-gradient(90deg,rgba(251,191,36,.15),rgba(30,41,59,.8));border-left:4px solid var(--gold);animation:pulse-gold 2s infinite}@keyframes pulse-gold{50%{border-color:var(--gold);box-shadow:0 0 10px rgba(251,191,36,.2)}}.lb-rank{font-family:var(--font-headings);font-weight:800;font-size:1.5rem;width:60px;text-align:center;color:var(--text-muted)}.qualified .lb-rank{color:var(--success)}.lb-img{width:70px;height:70px;border-radius:50%;margin:0 20px;border:3px solid rgba(255,255,255,.1);object-fit:cover;flex-shrink:0}.lb-info{flex:1}.lb-name{font-weight:700;font-size:1.2rem;margin-bottom:4px}.lb-status{font-size:.75rem;text-transform:uppercase;letter-spacing:1px;font-weight:700}.score-control-group{display:flex;align-items:center;gap:5px;background:rgba(0,0,0,.3);padding:5px;border-radius:10px;border:1px solid rgba(255,255,255,.1)}.btn-score-adj{width:40px;height:40px;border-radius:8px;border:none;background:rgba(255,255,255,.1);color:#fff;font-size:1.2rem;cursor:pointer}.btn-score-adj:hover{background:var(--accent-primary)}.score-display-input{width:100px;text-align:center;background:0 0;border:none;font-family:var(--font-headings);font-size:2rem;font-weight:700;color:var(--text-main)}.score-display-input:focus{outline:0;color:var(--accent-glow)}.score-display-input::-webkit-inner-spin-button,.score-display-input::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}.cut-separator{height:2px;background:linear-gradient(90deg,transparent,var(--danger),transparent);margin:20px 0;position:relative;display:flex;justify-content:center;align-items:center}.cut-badge{background:var(--bg-dark);border:1px solid var(--danger);color:var(--danger);padding:5px 15px;border-radius:20px;font-size:.8rem;font-weight:700;letter-spacing:2px;box-shadow:0 0 10px rgba(239,68,68,.4);text-transform:uppercase}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);backdrop-filter:blur(5px);z-index:1000;display:none;align-items:center;justify-content:center}.modal-content{background:var(--bg-panel);border:1px solid var(--accent-primary);box-shadow:0 0 40px rgba(59,130,246,.4);padding:30px;border-radius:20px;width:400px;text-align:center;animation:popIn .3s cubic-bezier(.175,.885,.32,1.275)}.score-display{display:flex;justify-content:center;align-items:center;gap:20px;margin:20px 0}.score-box{text-align:center}.score-box input{font-size:2rem;width:80px;text-align:center;font-family:'Rajdhani';font-weight:700;background:rgba(0,0,0,.5);border:2px solid rgba(255,255,255,.1)}.score-box input:focus{border-color:var(--gold);color:var(--gold)}.score-name{font-size:.9rem;margin-bottom:5px;color:var(--text-muted)}.schedule-grid-container{display:grid;gap:15px}.schedule-row{display:grid;grid-template-columns:200px 1fr 100px;align-items:start;gap:20px;background:rgba(0,0,0,.2);padding:15px;border-radius:12px;border:1px solid rgba(255,255,255,.05);transition:all .2s}.schedule-row:hover{background:rgba(255,255,255,.05);border-color:rgba(255,255,255,.1)}.schedule-label{font-family:var(--font-headings);font-weight:700;font-size:1rem;color:var(--accent-glow);text-transform:uppercase;margin-top:10px}.schedule-inputs-wrapper{display:flex;gap:10px;align-items:center;width:100%;flex-wrap:wrap}.schedule-mode-select{width:160px;padding:8px;font-size:.8rem}.schedule-input{flex:1;padding:10px;font-size:.9rem;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.1);color:var(--text-main);border-radius:6px}.export-sched-grid{display:flex;flex-direction:column;gap:12px;width:100%}.export-sched-row{display:flex;align-items:stretch;background:linear-gradient(90deg,rgba(30,41,59,.9) 0,rgba(15,23,42,.8) 100%);border:1px solid rgba(255,255,255,.1);border-radius:12px;overflow:hidden;box-shadow:0 4px 6px rgba(0,0,0,.1)}.export-sched-label{width:250px;padding:20px;display:flex;align-items:center;font-family:var(--font-headings);font-weight:700;font-size:1.2rem;text-transform:uppercase;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,.2);flex-shrink:0}.lbl-group,.lbl-quali{background:linear-gradient(135deg,#3b82f6,#60a5fa)}.lbl-af{background:linear-gradient(135deg,#8b5cf6,#a78bfa)}.lbl-vf{background:linear-gradient(135deg,#ec4899,#f472b6)}.lbl-hf{background:linear-gradient(135deg,#f59e0b,#fbbf24)}.lbl-final{background:linear-gradient(135deg,#ef4444,#f87171)}.lbl-p3{background:linear-gradient(135deg,#10b981,#34d399)}.export-sched-val{flex:1;padding:15px 25px;display:flex;flex-direction:column;justify-content:center;gap:5px;color:var(--text-main);border-left:1px solid rgba(255,255,255,.1);position:relative}.export-sched-time{font-size:1.4rem;font-weight:600;display:flex;align-items:center}.export-sched-time span{color:var(--gold);margin-right:15px;font-size:1.6rem}.export-match-detail{font-size:1rem;color:var(--text-muted);border-top:1px solid rgba(255,255,255,.1);padding-top:8px;margin-top:5px}.status-badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:.8rem;font-weight:700;text-transform:uppercase}.status-done{background:rgba(16,185,129,.2);color:var(--success);border:1px solid var(--success)}.status-running{background:rgba(251,191,36,.2);color:var(--gold);border:1px solid var(--gold)}.status-pending{background:rgba(148,163,184,.2);color:var(--text-muted);border:1px solid var(--text-muted)}.bracket-split-container{display:flex;justify-content:center;align-items:stretch;margin:0 auto;padding:0 40px;min-width:min-content;transform-origin:center center}.side-block{display:flex}.bracket-left{flex-direction:row}.bracket-right{flex-direction:row-reverse}.center-block{display:flex;flex-direction:column;justify-content:center;align-items:center;gap:40px;margin:0 40px;z-index:20;position:relative;min-width:300px}.match-pair{display:flex;flex-direction:column;justify-content:space-around;position:relative;margin-bottom:20px;flex:1;z-index:1}.round-col:hover{z-index:5000}.match-pair:hover{z-index:6000}.bracket-left .match-pair::before{content:'';position:absolute;right:-25px;top:25%;bottom:25%;width:2px;background:rgba(255,255,255,.3);border-right:2px solid rgba(255,255,255,.3)}.bracket-left .match-pair::after{content:'';position:absolute;right:-50px;top:50%;width:25px;height:2px;background:rgba(255,255,255,.3)}.bracket-left .match-pair .match-card::after{content:'';position:absolute;right:-25px;top:50%;width:25px;height:2px;background:rgba(255,255,255,.3)}.bracket-right .match-pair::before{content:'';position:absolute;left:-25px;top:25%;bottom:25%;width:2px;background:rgba(255,255,255,.3);border-left:2px solid rgba(255,255,255,.3)}.bracket-right .match-pair::after{content:'';position:absolute;left:-50px;top:50%;width:25px;height:2px;background:rgba(255,255,255,.3)}.bracket-right .match-pair .match-card::after{content:'';position:absolute;left:-25px;top:50%;width:25px;height:2px;background:rgba(255,255,255,.3)}.match-single{display:flex;flex-direction:column;justify-content:center;flex:1;position:relative}.bracket-left .match-single .match-card::after{content:'';position:absolute;right:-50px;top:50%;width:50px;height:2px;background:rgba(255,255,255,.3)}.bracket-right .match-single .match-card::after{content:'';position:absolute;left:-50px;top:50%;width:50px;height:2px;background:rgba(255,255,255,.3)}.final-connector-left{position:absolute;top:50%;right:100%;width:40px;height:2px;background:rgba(255,255,255,.3)}.final-connector-right{position:absolute;top:50%;left:100%;width:40px;height:2px;background:rgba(255,255,255,.3)}.center-block .match-card::after,.center-block .match-card::before{display:none}.bracket-bg-layer{position:absolute;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none;background-size:cover;background-position:center;opacity:.15;filter:grayscale(.5)}.assignment-container{display:flex;gap:30px;height:70vh}.assign-target-area,.assign-pool-area{flex:1;background:rgba(0,0,0,.2);border-radius:12px;padding:20px;overflow-y:auto;border:1px solid rgba(255,255,255,.1);min-height:200px}.assign-pool-area{display:flex;flex-wrap:wrap;align-content:flex-start;gap:10px}.assign-slot-group{margin-bottom:20px;background:rgba(255,255,255,.05);padding:10px;border-radius:8px}.assign-slot-header{font-weight:700;color:var(--accent-glow);margin-bottom:10px;text-transform:uppercase;font-size:.9rem}.assign-slot{background:rgba(0,0,0,.3);border:1px dashed rgba(255,255,255,.2);padding:10px;margin-bottom:5px;border-radius:6px;min-height:45px;display:flex;align-items:center;justify-content:space-between}.assign-slot.filled{border-style:solid;border-color:var(--success);background:rgba(16,185,129,.1)}.draggable-item{background:var(--bg-card);padding:5px 10px;border-radius:4px;cursor:grab;border:1px solid rgba(255,255,255,.2);font-size:.9rem;display:flex;align-items:center;gap:8px;user-select:none;z-index:100}.draggable-item *{pointer-events:none}.draggable-item:active{cursor:grabbing;background:var(--accent-primary)}.drag-placeholder{opacity:.5;background:rgba(255,255,255,.1)}.match-card{z-index:1;position:relative}.match-card:hover{z-index:9999!important}.bracket-scale-32 .match-card:hover{transform:scale(2.5)!important;box-shadow:0 0 40px rgba(0,0,0,.95)}.bracket-scale-16 .match-card:hover{transform:scale(1.8)!important;box-shadow:0 0 40px rgba(0,0,0,.95)}.bracket-scale-8 .match-card:hover{transform:scale(1.3)!important;box-shadow:0 0 40px rgba(0,0,0,.95)}.matchday-header{text-align:center;font-weight:700;color:var(--gold);margin-top:15px;margin-bottom:5px;font-size:.8rem;letter-spacing:2px;border-bottom:1px dashed rgba(255,255,255,.1);padding-bottom:3px}.detailed-schedule-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px;margin-top:15px;width:100%;padding:10px;background:rgba(0,0,0,.1);border-radius:8px}.detailed-match-item{background:rgba(255,255,255,.05);padding:10px;border-radius:6px;border:1px solid rgba(255,255,255,.1)}.detailed-match-title{font-size:.8rem;color:var(--text-muted);margin-bottom:5px;font-weight:700}.streamer-card{display:flex;align-items:center;background:rgba(0,0,0,.4);padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.1);gap:15px;margin-bottom:10px}.streamer-img{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,.2);cursor:pointer}.streamer-name-input{flex:1;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.2);color:#fff;padding:8px;border-radius:4px;font-size:1rem}.platform-toggle{cursor:pointer;opacity:.3;filter:grayscale(1);transition:all .2s;font-size:.9rem;display:flex;align-items:center;justify-content:center;width:auto;height:auto;padding:5px 10px;border-radius:4px;background:rgba(255,255,255,.05);gap:6px;border:1px solid rgba(255,255,255,.1)}.platform-toggle.active{opacity:1;filter:grayscale(0);transform:scale(1.05);background:rgba(255,255,255,.1);border-color:var(--accent-glow)}.st-icon-yt{color:#f00;text-shadow:0 0 10px rgba(255,0,0,.6);font-weight:900;font-size:1.2rem}.st-icon-tw{color:#a970ff;text-shadow:0 0 10px rgba(169,112,255,.6);font-weight:900;font-size:1.2rem}.streamer-display{display:flex;align-items:center;gap:8px;font-size:.9rem;color:var(--accent-glow);background:rgba(59,130,246,.15);padding:4px 10px;border-radius:20px;border:1px solid rgba(59,130,246,.3);margin-left:15px;width:fit-content;box-shadow:0 2px 5px rgba(0,0,0,.3)}.export-sched-time span.st-icon-yt{color:#f00!important;-webkit-text-fill-color:#f00!important}.export-sched-time span.st-icon-tw{color:#a970ff!important;-webkit-text-fill-color:#a970ff!important}.st-export-label{font-size:.6em;margin-left:2px;margin-right:5px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;vertical-align:middle;text-align:center}.p-img-wrapper:hover .p-img-edit-overlay{opacity:1}</style></head><body data-theme="dark"><header><div style="display:flex;align-items:center;gap:10px"><div style="font-size:2rem">üí†</div><h1 id="header-title">TOURNAMENT MANAGER PRO V7.8</h1></div><nav><button class="nav-btn active" onclick="switchTab('setup')">‚öôÔ∏è Setup</button><button class="nav-btn" onclick="switchTab('assignment')" id="nav-assignment" style="display:none">üìù Zuordnung</button><button class="nav-btn" onclick="switchTab('schedule')" id="nav-schedule" style="display:none">üìÖ Zeitplan</button><button class="nav-btn" onclick="switchTab('groups')" id="nav-groups" style="display:none">üìä Gruppen</button><button class="nav-btn" onclick="switchTab('release')" id="nav-release" style="display:none">‚õ≥ Ranking</button><button class="nav-btn" onclick="switchTab('bracket')" id="nav-bracket" style="display:none">üéã Turnierbaum</button><button class="nav-btn" onclick="switchTab('export')">üì∑ Export</button></nav><div style="display:flex;align-items:center;gap:15px"><button onclick="exportToFile()" class="btn btn-secondary" style="margin:0;padding:5px 15px;font-size:.8rem;height:auto">üíæ Speichern</button><button onclick="toggleTheme()" style="background:0 0;border:none;font-size:1.5rem;cursor:pointer;opacity:.8" title="Theme Switch">üåó</button></div></header><div class="container"><div id="view-setup" class="view-section active"><div style="display:flex;gap:30px;flex-wrap:wrap"><div class="panel" style="flex:1;min-width:350px"><div class="panel-header"><h2>üë• Teilnehmer (<span id="p-count" style="color:var(--accent-glow)">0</span>)</h2><button class="btn btn-danger" onclick="clearParticipants()" style="width:auto;padding:5px 15px;font-size:.8rem;margin:0">L√∂schen</button></div><div style="display:flex;gap:10px;margin-bottom:20px"><input type="text" id="new-p-name" placeholder="Neuer Spielername..." onkeypress="if(event.key==='Enter') addParticipant()"><button class="btn btn-primary" onclick="addParticipant()" style="width:auto;margin:0">‚ûï</button></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px"><label class="file-label"><span style="font-size:1.5rem">üìÇ</span><span style="font-size:.8rem;margin-top:5px;color:var(--text-muted)">Bilder-Ordner</span><input type="file" webkitdirectory directory multiple onchange="handleFolderUpload(this)"></label><label class="file-label"><span style="font-size:1.5rem">üìÑ</span><span style="font-size:.8rem;margin-top:5px;color:var(--text-muted)">Namensliste (.txt)</span><input type="file" accept=".txt" onchange="handleTextUpload(this)"></label></div><div id="participant-list" class="participant-grid"></div><button class="btn btn-secondary" onclick="openStreamerModal()" style="margin-top:20px;border-color:var(--accent-secondary);color:var(--accent-secondary)">üì° Streamer Verwaltung</button></div><div class="panel" style="flex:1;min-width:350px"><div class="panel-header"><h2>‚öôÔ∏è Struktur-Parameter</h2></div><div style="margin-bottom:20px;text-align:right"><label class="btn btn-secondary" style="width:auto;display:inline-flex;margin:0;cursor:pointer">üìÇ Spielstand laden<input type="file" accept=".json" style="display:none" onchange="importFromFile(this)"></label></div><div style="display:flex;flex-direction:column;gap:15px"><div><label style="font-size:.8rem;color:var(--text-muted);margin-bottom:5px;display:block">Turnier-Name</label><input type="text" id="tourn-name" placeholder="Mein Turnier..." onchange="saveTournamentName(this.value)"></div><div><label style="font-size:.8rem;color:var(--text-muted);margin-bottom:5px;display:block">Turnier-Modus</label><select id="tourn-mode" onchange="toggleConfigOptions()"><option value="groups_ko">Gruppenphase + K.O.-System</option><option value="ko_only">Nur K.O.-System (Turnierbaum)</option><option value="release">Release Turnier (Qualifikation + K.O. System)</option></select></div><div id="config-scoring"><label style="font-size:.8rem;color:var(--text-muted);margin-bottom:5px;display:block">Wertungs-Modus</label><select id="scoring-mode"><option value="matchplay">‚öΩ Matchplay (Punkte / MP)</option><option value="strokeplay">‚õ≥ Strokeplay (SuP / Schl√§ge)</option></select><p style="font-size:.7rem;color:var(--text-muted);margin-top:5px">Bei Strokeplay gewinnt der <b>niedrigere</b> Wert.</p></div><div id="config-groups"><div style="margin-bottom:15px"><label style="font-size:.8rem;color:var(--text-muted);margin-bottom:5px;display:flex;justify-content:space-between">Anzahl Gruppen <span style="color:var(--accent-primary);cursor:pointer" onclick="setAuto('groups')">[AUTO]</span></label><select id="group-count"><option value="auto">Automatisch</option><option value="2">2 Gruppen</option><option value="4">4 Gruppen</option><option value="8">8 Gruppen</option><option value="16">16 Gruppen</option></select></div><div style="margin-bottom:15px"><label style="font-size:.8rem;color:var(--text-muted);margin-bottom:5px;display:block">Weiterkommende pro Gruppe</label><select id="advancing-count"><option value="2">Top 2</option><option value="1">Top 1</option><option value="3">Top 3</option><option value="4">Top 4</option></select></div><div><label style="font-size:.8rem;color:var(--text-muted);margin-bottom:5px;display:block">Start der Finalrunde</label><select id="group-ko-round"><option value="auto">Automatisch</option><option value="32">Sechzehntelfinale</option><option value="16">Achtelfinale</option><option value="8">Viertelfinale</option><option value="4">Halbfinale</option><option value="2">Finale</option></select></div></div><div id="config-ko" style="display:none"><label style="font-size:.8rem;color:var(--text-muted);margin-bottom:5px;display:flex;justify-content:space-between">Startrunde <span style="color:var(--accent-primary);cursor:pointer" onclick="setAuto('ko')">[AUTO]</span></label><select id="ko-start-round"><option value="auto">Automatisch</option><option value="32">Sechzehntelfinale</option><option value="16">Achtelfinale</option><option value="8">Viertelfinale</option><option value="4">Halbfinale</option><option value="2">Finale</option></select></div><div id="config-release" style="display:none"><div style="background:rgba(251,191,36,.1);border:1px solid var(--gold);padding:10px;border-radius:8px"><p style="margin:0;font-size:.9rem;color:var(--gold)">‚ÑπÔ∏è <b>Release Modus:</b><br>1. Quali-Runde<br>2. Ranking nach SuP<br>3. Top 16 ins Achtelfinale.</p></div></div><div style="margin-top:10px;background:rgba(0,0,0,.2);padding:10px;border-radius:8px"><label style="display:flex;align-items:center;gap:10px;cursor:pointer;margin-bottom:10px"><input type="checkbox" id="shuffle-participants" checked style="width:auto;height:auto"><span style="font-size:.9rem">Teilnehmer mischen (bei Auto)</span></label><label style="font-size:.8rem;color:var(--text-muted);margin-bottom:5px;display:block">Zuordnung</label><select id="assignment-mode"><option value="auto">‚ö° Automatisch (Zufall)</option><option value="manual">‚úã Manuell (Drag & Drop)</option></select></div><div style="border-top:1px solid rgba(255,255,255,.1);margin-top:10px;padding-top:20px"><button class="btn btn-primary" onclick="initTournament()" style="font-size:1.1rem;padding:15px">üöÄ Turnier Generieren</button></div><button class="btn btn-secondary" onclick="resetTournament()" style="font-size:.8rem">‚ö†Ô∏è Zur√ºcksetzen</button></div></div></div></div><div id="view-assignment" class="view-section"><div class="panel"><div class="panel-header"><h2>üìù Teilnehmer Zuordnung</h2><div style="color:var(--text-muted);font-size:.9rem">Bitte alle Teilnehmer den Pl√§tzen zuweisen.</div></div><div class="assignment-container"><div class="assign-target-area" id="assign-target-container"></div><div class="assign-pool-area" id="assign-pool-container"></div></div><div style="margin-top:30px;text-align:center;display:flex;justify-content:center;gap:20px"><button class="btn btn-secondary" style="max-width:200px" onclick="switchTab('setup')">‚¨ÖÔ∏è Zur√ºck</button><button class="btn btn-primary" style="max-width:200px" onclick="confirmAssignment()">‚úÖ Zuordnung best√§tigen</button></div></div></div><div id="view-schedule" class="view-section"><div class="panel"><div class="panel-header"><h2>üìÖ Turnier Zeitplan</h2><div style="display:flex;gap:10px;align-items:center"><button onclick="autoSchedule()" class="btn btn-primary" style="margin:0;width:auto;font-size:.9rem">‚ö° Auto-Verteilung</button></div></div><div style="background:rgba(0,0,0,.2);padding:20px;border-radius:12px;margin-bottom:30px;border:1px solid var(--accent-primary)"><label style="font-size:.9rem;font-weight:700;color:var(--text-main);margin-bottom:15px;display:block">ZEITRAUM</label><div style="display:grid;grid-template-columns:1fr 1fr;gap:20px"><div><label style="font-size:.75rem;color:var(--text-muted);display:block;margin-bottom:5px">Start</label><input type="date" id="tourn-start-date"></div><div><label style="font-size:.75rem;color:var(--text-muted);display:block;margin-bottom:5px">Ende</label><input type="date" id="tourn-end-date"></div></div></div><div id="schedule-list" class="schedule-grid-container"></div><div style="margin-top:30px;text-align:center;display:flex;justify-content:center;gap:20px"><button class="btn btn-secondary" style="max-width:200px" onclick="switchTab('setup')">‚¨ÖÔ∏è Setup</button><button class="btn btn-primary" style="max-width:200px" onclick="confirmSchedule()">‚úÖ Best√§tigen</button></div></div></div><div id="view-groups" class="view-section"><div class="panel"><div class="panel-header"><h2>Gruppenphase</h2><div style="display:flex;gap:10px"><button class="btn btn-warning" onclick="simulateGroupMatches()" style="width:auto;margin:0;font-size:.8rem">üé≤ Sim</button><button class="btn btn-secondary" onclick="checkGroupCompletion()" style="width:auto;margin:0">üîÑ Aktualisieren</button></div></div><div id="groups-display" class="groups-container"></div><div style="margin-top:40px;display:flex;justify-content:center"><button class="btn btn-primary" onclick="advanceToKnockout()" id="btn-advance-ko" style="max-width:400px;display:none;animation:pulse 2s infinite">‚û°Ô∏è K.O. starten</button></div></div></div><div id="view-release" class="view-section"><div class="panel"><div class="panel-header"><h2>‚õ≥ Release Ranking</h2><div style="display:flex;gap:10px"><button class="btn btn-warning" onclick="simulateReleaseScores()" style="width:auto;margin:0;font-size:.8rem">üé≤ Sim</button><button class="btn btn-secondary" onclick="refreshRanking()" style="width:auto;margin:0;font-size:.9rem">üîÑ Sortieren</button></div></div><div id="leaderboard-target" class="leaderboard-container"></div><div style="display:flex;justify-content:center;position:sticky;bottom:20px;z-index:50"><button class="btn btn-primary" onclick="advanceReleaseToBracket()" id="btn-release-advance" style="max-width:500px;padding:15px;box-shadow:0 10px 30px rgba(0,0,0,.5)">‚û°Ô∏è Top 16 ins Achtelfinale</button></div></div></div><div id="view-bracket" class="view-section"><div class="panel" style="padding:0;background:rgba(15,23,42,.5)"><div style="padding:20px;border-bottom:1px solid rgba(255,255,255,.1);display:flex;justify-content:space-between;align-items:center"><h2>Turnierbaum</h2><div style="display:flex;gap:10px;align-items:center"><label class="btn btn-secondary" style="width:auto;margin:0;font-size:.8rem;padding:5px 10px;cursor:pointer">üñºÔ∏è Hintergrund<input type="file" accept="image/*" style="display:none" onchange="handleBracketBackground(this)"></label><button class="btn btn-warning" onclick="simulateBracketRound()" style="width:auto;margin:0;font-size:.8rem">üé≤ Sim</button></div></div><div id="bracket-display" class="bracket-wrapper"></div></div></div><div id="view-export" class="view-section"><div class="panel"><div class="panel-header"><h2>High-Res Export</h2></div><div id="export-group-buttons-container" style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap"></div><div style="display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap"><button class="btn btn-primary" onclick="renderExport('bracket')" style="flex:1">Turnierbaum</button><button class="btn btn-secondary" onclick="renderExport('release')" style="flex:1" id="btn-export-release">Ranking</button><button class="btn btn-secondary" onclick="renderExport('schedule')" style="flex:1;border-color:var(--gold);color:var(--gold)">üìÖ Zeitplan</button></div><div id="export-canvas-container" style="border:2px dashed rgba(255,255,255,.1);padding:20px;background:rgba(0,0,0,.5);overflow:auto;border-radius:12px"><div id="export-target" style="padding:50px;background:linear-gradient(135deg,#0f172a 0,#1e293b 100%);color:#fff;min-width:1000px;width:fit-content;border-radius:10px;position:relative;overflow:visible"><div id="export-bg-layer" style="position:absolute;top:0;left:0;width:100%;height:100%;background-size:cover;background-position:center;opacity:.1;pointer-events:none;z-index:0"></div><div style="text-align:center;margin-bottom:30px;position:relative;z-index:2"><h1 id="export-title" style="font-size:3rem;text-shadow:0 0 20px rgba(59,130,246,.5)">TURNIER √úBERSICHT</h1><div id="export-subtitle" style="margin-bottom:20px;color:var(--accent-glow);font-family:var(--font-headings);font-size:1.5rem"></div></div><div id="export-content" style="position:relative;z-index:2"></div></div></div><button class="btn btn-primary" onclick="downloadImage()" style="margin-top:20px">üíæ Bild Speichern (PNG)</button></div></div></div><div id="match-modal" class="modal-overlay"><div class="modal-content"><h3 style="margin-top:0;font-family:'Rajdhani';letter-spacing:1px;color:var(--accent-glow)">MATCH ERGEBNIS</h3><div class="score-display"><div class="score-box"><div class="score-name" id="m-p1-name">P1</div><input type="number" id="m-score1"></div><div style="font-weight:900;font-size:1.5rem;color:var(--text-muted)">-</div><div class="score-box"><div class="score-name" id="m-p2-name">P2</div><input type="number" id="m-score2"></div></div><div id="penalty-section" style="text-align:center;margin-bottom:20px;display:none"><p style="font-size:.8rem;color:var(--gold);margin-bottom:10px">‚ö†Ô∏è Wer kommt weiter?</p><div style="display:flex;justify-content:center;gap:15px"><label style="cursor:pointer;background:rgba(255,255,255,.05);padding:5px 10px;border-radius:5px"><input type="radio" name="winner-force" value="1"> P1</label><label style="cursor:pointer;background:rgba(255,255,255,.05);padding:5px 10px;border-radius:5px"><input type="radio" name="winner-force" value="2"> P2</label></div></div><div style="display:flex;gap:10px"><button class="btn btn-secondary" onclick="closeMatchModal()">Abbrechen</button><button class="btn btn-primary" onclick="saveMatchResult()">Speichern</button></div></div></div><div id="streamer-modal" class="modal-overlay" style="z-index:2000"><div class="modal-content" style="width:80%;max-width:1000px;height:80%;display:flex;flex-direction:column;text-align:left"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><h2 style="margin:0;color:var(--accent-secondary)">üì° Streamer Verwaltung</h2><button onclick="closeStreamerModal()" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer">‚úñ</button></div><div style="display:flex;gap:15px;margin-bottom:15px;justify-content:center"><label class="btn btn-secondary" style="width:auto;font-size:0.9rem">Upload YouTube Logo<input type="file" accept="image/*" style="display:none" onchange="handlePlatformLogoUpload('yt',this)"></label><label class="btn btn-secondary" style="width:auto;font-size:0.9rem">Upload Twitch Logo<input type="file" accept="image/*" style="display:none" onchange="handlePlatformLogoUpload('tw',this)"></label></div><div style="display:flex;gap:10px;margin-bottom:15px;align-items:center"><input type="text" id="new-streamer-name" placeholder="Name..." onkeypress="if(event.key==='Enter') addStreamer()"><button class="btn btn-primary" onclick="addStreamer()" style="width:auto;margin:0">‚ûï</button></div><label class="file-label" style="padding:10px;margin-bottom:15px;flex-direction:row;gap:10px"><span style="font-size:1.2rem">üìÑ</span><span style="font-size:.9rem;color:var(--text-muted)">Liste importieren (.txt)</span><input type="file" accept=".txt" onchange="handleStreamerTextUpload(this)"></label><div id="streamer-list" style="flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:10px;padding-right:10px"></div><div style="margin-top:20px;text-align:center"><button class="btn btn-primary" style="max-width:300px" onclick="saveStreamerSettings()">üíæ Speichern</button></div></div></div><script>const d=document,gID=i=>d.getElementById(i),cE=t=>d.createElement(t),D_IMG='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmZmIiBzdHJva2Utd2lkdGg9IjIiPjxjaXJjbGUgY3g9IjEyIiBjeT0iOCIgcj0iNCIvPjxwYXRoIGQ9Ik02IDIxdi0yYTQgNCAwIDAgMCA0LTRoNGE0IDQgMCAwIDAgNCc0djIiLz48L3N2Zz4=',D_YT='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0icmVkIj48cGF0aCBkPSJNMTkuNjE1IDMuMTg0Yy0yLjM2OS0uMTg1LTguNDk1LS4yMDItMTEuMzMuMDItMi44MzUuMjIyLTUuMzUzLjY5OC01LjI1MiA2LjE0OC0uMTAxIDUuNDUtLjAzMSA5LjQ1OC4wNDggOS44NDEuMDc5LjM4My41NjcuNTQ4LjU2Ny41NDhMMjEgMjFjMi44NTctMi44MzUgMy04LjU1IDMtMTEuNjdDMjQgMy44NzUgMTkuNjE1IDMuMTg0IDE5LjYxNSAzLjE4NHpNMTAgMTV2LTZsNSAzeiIvPjwvc3ZnPg==',D_TW='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzkxNDZGRiI+PHBhdGggZD0iTTExLjU3MSA0LjcxNGgtMi41N3Y1LjE0M2gyLjU3em00LjcxNSAwaC0yLjU3MXY1LjE0M2gyLjU3MXpNNiAwaDEzdjE0LjU3MWwtMy44NTcgMy44NT7IOXY0LjI4Nkg0LjcxNFYxOC40MjhIMVoiLz48L3N2Zz4=';let participants=[],imageRegistry={},tournamentData={active:!1,config:{mode:'groups_ko',scoringMode:'matchplay',tournamentName:'Turnier'},groups:[],bracket:[],thirdPlace:{p1:null,p2:null,score1:null,score2:null,winnerId:null,completed:!1},release:{scores:{},relegationScores:{}},schedule:{start:null,end:null,config:{},phases:{},streamerAssignments:{}},bracketBg:null,currentStage:'setup'},currentMatchIdEdit=null;let manualAssignmentState={slots:[],assigned:{}};let currentExportState={t:'bracket',id:null};let streamers=[],streamerConfig={ytLogo:null,twLogo:null};d.addEventListener('DOMContentLoaded',()=>{loadData();renderParticipantList();updateUIState();window.addEventListener('resize',fitBracketToScreen)});function toggleTheme(){const b=d.body,c=b.getAttribute('data-theme');b.setAttribute('data-theme',c==='dark'?'light':'dark');saveData()}
function switchTab(id){d.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));d.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));gID(`view-${id}`).classList.add('active');Array.from(d.querySelectorAll('.nav-btn')).find(b=>b.getAttribute('onclick').includes(id))?.classList.add('active');if(id==='bracket'){setTimeout(fitBracketToScreen,100)}if(id==='export'){const c=gID('export-group-buttons-container');c.innerHTML='';if(tournamentData.active&&tournamentData.config.mode==='groups_ko'){const bA=cE('button');bA.className='btn btn-secondary';bA.innerText='Alle Gruppen';bA.style.flex='1';bA.onclick=()=>renderExport('groups');c.appendChild(bA);tournamentData.groups.forEach(g=>{const b=cE('button');b.className='btn btn-secondary';b.innerText=g.name;b.style.flex='1';b.onclick=()=>renderExport('single_group',g.id);c.appendChild(b)})}const bR=gID('btn-export-release');bR.style.display=tournamentData.config.mode==='release'?'block':'none';updateExportIfActive()}window.scrollTo(0,0);d.body.scrollTop=0;d.documentElement.scrollTop=0}
function toggleConfigOptions(){const m=gID('tourn-mode').value,gc=gID('config-groups'),kc=gID('config-ko'),rc=gID('config-release'),sc=gID('config-scoring');gc.style.display='none';kc.style.display='none';rc.style.display='none';sc.style.display='block';if(m==='groups_ko')gc.style.display='block';else if(m==='ko_only')kc.style.display='block';else if(m==='release'){rc.style.display='block';sc.style.display='none'}}
function saveTournamentName(v){tournamentData.config.tournamentName=v;gID('header-title').innerText=v.toUpperCase();saveData()}
function colorScore(o,p){if(o===null||p===null)return'-';const sp=(tournamentData.config.mode==='release')||(tournamentData.config.scoringMode==='strokeplay');let w=0,l=0;if(sp){if(o<p)w=1;else if(o>p)l=1}else{if(o>p)w=1;else if(o<p)l=1}return `<span style="color:${w?'var(--success)':l?'var(--danger)':'var(--text-main)'};font-weight:bold;">${o}</span>`}
function colorName(n,o,p){if(o===null||p===null)return n;const sp=(tournamentData.config.mode==='release')||(tournamentData.config.scoringMode==='strokeplay');let w=0,l=0;if(sp){if(o<p)w=1;else if(o>p)l=1}else{if(o>p)w=1;else if(o<p)l=1}return `<span style="color:${w?'var(--success)':l?'var(--danger)':'inherit'};font-weight:bold;">${n}</span>`}
function getMedal(pid){if(!pid||pid.startsWith('TBD')||pid==='BYE')return'';const p3=tournamentData.thirdPlace;if(p3&&p3.completed&&p3.winnerId===pid)return' ü•â';if(tournamentData.bracket.length>0){const l=tournamentData.bracket[tournamentData.bracket.length-1];if(l&&l.length>0){const f=l[0];if(f.completed){if(f.winnerId===pid)return' ü•á';if(f.p1===pid||f.p2===pid)return' ü•à'}}}return''}
function calculateGroupMatchdays(){if(tournamentData.groups.length===0)return 1;let m=0;tournamentData.groups.forEach(g=>{if(g.participants.length>m)m=g.participants.length});if(m<2)return 1;return(m%2===0)?m-1:m}
function manualSaveSchedule(){saveData();renderExport('schedule');alert("Zeiten gespeichert und √ºbernommen.")}
function getRoundName(i,tr){const rev=tr-1-i,n=["Finale","Halbfinale","Viertelfinale","Achtelfinale","16tel-Finale"];return rev<n.length?n[rev]:`Runde der ${Math.pow(2,rev+1)}`}
function toggleScheduleMode(id,v){if(!tournamentData.schedule.config)tournamentData.schedule.config={};tournamentData.schedule.config[id]=v;renderScheduleView();updateExportIfActive()}
function savePhaseInput(k,v){if(!tournamentData.schedule.phases)tournamentData.schedule.phases={};tournamentData.schedule.phases[k]=v;tournamentData.schedule.start=gID('tourn-start-date').value;tournamentData.schedule.end=gID('tourn-end-date').value;updateExportIfActive()}
function autoSchedule(){const sS=gID('tourn-start-date').value,eS=gID('tourn-end-date').value;if(!sS||!eS)return alert("Datum w√§hlen.");const s=new Date(sS),e=new Date(eS);if(e<s)return alert("Ende vor Start?");const diff=Math.ceil(Math.abs(e-s)/(864e5))+1,ids=[],cnt=gID('schedule-list');cnt.querySelectorAll('.schedule-row').forEach(r=>ids.push(r.querySelector('select').getAttribute('onchange').match(/'([^']+)'/)[1]));const dps=Math.max(1,Math.floor(diff/ids.length));let cur=new Date(s);const fD=d=>d.toISOString().split('T')[0],fT=(d,h)=>{return d.toISOString().split('T')[0]+`T${String(h).padStart(2,'0')}:00`};ids.forEach((id,x)=>{const last=x===ids.length-1,t=tournamentData.schedule.config[id]||'range';let se=new Date(cur);if(last)se=new Date(e);else{se.setDate(se.getDate()+dps-1);if(se>e)se=new Date(e)}if(t==='range'){savePhaseInput(id+'_start',fD(cur));savePhaseInput(id+'_end',fD(se))}else savePhaseInput(id,fT(se,last?18:14));cur=new Date(se);cur.setDate(cur.getDate()+1);if(cur>e)cur=new Date(e)});renderScheduleView()}
function confirmSchedule(){const m=tournamentData.config.mode;if(m==='groups_ko')switchTab('groups');else if(m==='release')switchTab('release');else switchTab('bracket');alert("Zeitplan gespeichert!");saveData()}
function addParticipant(){const i=gID('new-p-name'),n=i.value.trim();if(!n)return;if(participants.some(p=>p.name===n))return alert('Name existiert!');participants.push({id:'p_'+Date.now()+Math.random().toString(36).substr(2,5),name:n,img:imageRegistry[n]||null});i.value='';renderParticipantList();saveData()}
function removeParticipant(id){participants=participants.filter(p=>p.id!==id);renderParticipantList();saveData()}
function clearParticipants(){if(confirm("L√∂schen?")){participants=[];renderParticipantList();saveData()}}
function updateParticipantImage(id,inp){const f=inp.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{const p=participants.find(x=>x.id===id);if(p){p.img=e.target.result;saveData();renderParticipantList()}};r.readAsDataURL(f)}
function updateParticipantName(id,n){const p=participants.find(x=>x.id===id);if(p){p.name=n;saveData()}}
function renderParticipantList(){const g=gID('participant-list');gID('p-count').innerText=participants.length;g.innerHTML='';participants.forEach(p=>{const im=p.img||imageRegistry[p.name]||D_IMG,c=cE('div');c.className='p-card';c.innerHTML=`<label class="p-img-wrapper" title="Bild √§ndern"><img src="${im}" class="p-img"><input type="file" accept="image/*" style="display:none;" onchange="updateParticipantImage('${p.id}',this)"><div class="p-img-edit-overlay">‚úèÔ∏è</div></label><div style="flex:1;overflow:hidden;"><input type="text" class="p-name-input" value="${p.name}" onchange="updateParticipantName('${p.id}',this.value)"></div><button onclick="removeParticipant('${p.id}')" style="background:none;border:none;color:var(--danger);cursor:pointer;">‚úñ</button>`;g.appendChild(c)})}
function handleFolderUpload(i){Array.from(i.files).forEach(f=>{const n=f.name.substring(0,f.name.lastIndexOf('.')),r=new FileReader();r.onload=e=>{imageRegistry[n]=e.target.result;const p=participants.find(x=>x.name===n);if(p)p.img=e.target.result;renderParticipantList()};r.readAsDataURL(f)})}
function handleTextUpload(i){const f=i.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{const lines=e.target.result.split(/\r?\n/);let addedCount=0;lines.forEach((l,index)=>{const n=l.trim();if(n&&!participants.some(p=>p.name===n)){const uid='p_'+Date.now()+'_'+index+'_'+Math.random().toString(36).substr(2,5);participants.push({id:uid,name:n,img:imageRegistry[n]||null});addedCount++}});renderParticipantList();saveData();if(addedCount>0){alert(addedCount+" Teilnehmer importiert!");}else{alert("Keine neuen Teilnehmer gefunden oder Datei leer.");}i.value='';};r.readAsText(f)}
function setAuto(t){const c=participants.length;if(c<2)return alert("Zu wenige.");if(t==='groups')gID('group-count').value=c<=12?"2":c<=24?"4":"8";else gID('ko-start-round').value=c<=2?"2":c<=4?"4":c<=8?"8":c<=16?"16":"32"}
function initTournament(){if(participants.length<2)return alert("Min 2.");const m=gID('assignment-mode').value;if(m==='manual'){startManualAssignment()}else{startTournament(!0)}}
function startManualAssignment(){const m=gID('tourn-mode').value;manualAssignmentState={slots:[],assigned:{}};if(m==='groups_ko'){let gc=gID('group-count').value;const pl=participants.length;gc=gc==='auto'?(pl<=12?2:pl<=24?4:8):parseInt(gc);const ch="ABCDEFGHIJKLMNOPQRSTUVWXYZ";for(let i=0;i<gc;i++){manualAssignmentState.slots.push({id:`group_${i}`,name:`GRUPPE ${ch[i]}`,type:'group',items:[]})}}else if(m==='ko_only'){let tg=gID('ko-start-round').value;tg=tg==='auto'?Math.pow(2,Math.ceil(Math.log2(participants.length))):parseInt(tg);const matches=tg/2;const roundName=getRoundName(0,Math.log2(tg));for(let i=0;i<matches;i++){manualAssignmentState.slots.push({id:`match_${i}_p1`,name:`${roundName} ${i+1} (Heim)`,type:'bracket',items:[]});manualAssignmentState.slots.push({id:`match_${i}_p2`,name:`${roundName} ${i+1} (Gast)`,type:'bracket',items:[]})}}else{startTournament(!0);return}switchTab('assignment');renderAssignmentView()}
function renderAssignmentView(){const tgt=gID('assign-target-container');const pool=gID('assign-pool-container');tgt.innerHTML='';pool.innerHTML='';manualAssignmentState.slots.forEach(slot=>{const d=cE('div');d.className='assign-slot-group';let itemsHtml='';slot.items.forEach(pid=>{const p=participants.find(x=>x.id===pid);itemsHtml+=createDraggableHTML(p)});const emptyClass=slot.items.length===0?'':'filled';d.innerHTML=`<div class="assign-slot-header">${slot.name}</div><div class="assign-slot ${emptyClass}" ondragover="allowDrop(event)" ondrop="drop(event, '${slot.id}')">${itemsHtml}</div>`;tgt.appendChild(d)});participants.forEach(p=>{let assigned=!1;manualAssignmentState.slots.forEach(s=>{if(s.items.includes(p.id))assigned=!0});if(!assigned){const el=cE('div');el.innerHTML=createDraggableHTML(p);el.firstChild.setAttribute('draggable','true');pool.appendChild(el.firstChild)}})}
function createDraggableHTML(p){const im=p.img||imageRegistry[p.name]||D_IMG;return`<div class="draggable-item" id="drag_${p.id}" draggable="true" ondragstart="drag(event)" data-pid="${p.id}"><img src="${im}" style="width:20px;height:20px;border-radius:50%;object-fit:cover;"> ${p.name}</div>`}
function allowDrop(ev){ev.preventDefault()}
function drag(ev){ev.dataTransfer.setData("text",ev.target.dataset.pid)}
function drop(ev,targetSlotId){ev.preventDefault();ev.stopPropagation();const pid=ev.dataTransfer.getData("text");if(!pid)return;manualAssignmentState.slots.forEach(s=>{s.items=s.items.filter(id=>id!==pid)});const slot=manualAssignmentState.slots.find(s=>s.id===targetSlotId);if(slot){if(slot.type==='bracket'&&slot.items.length>=1){slot.items=[pid]}else{slot.items.push(pid)}}renderAssignmentView()}gID('assign-pool-container').ondragover=allowDrop;gID('assign-pool-container').ondrop=function(ev){ev.preventDefault();ev.stopPropagation();const pid=ev.dataTransfer.getData("text");if(!pid)return;manualAssignmentState.slots.forEach(s=>{s.items=s.items.filter(id=>id!==pid)});renderAssignmentView()};
function confirmAssignment(){const unassignedCount=gID('assign-pool-container').childElementCount;if(unassignedCount>0){if(!confirm("Es sind noch nicht alle Teilnehmer zugewiesen. Fortfahren? (Nicht zugewiesene werden ignoriert)"))return}startTournament(!1,manualAssignmentState)}
function startTournament(autoMode,manualData=null){const m=gID('tourn-mode').value,sm=gID('scoring-mode').value,tn=gID('tourn-name').value||"Turnier",sh=gID('shuffle-participants').checked;let r=[];if(autoMode){if(participants.length<2)return alert("Min 2.");r=JSON.parse(JSON.stringify(participants));if(sh)r.sort(()=>Math.random()-.5)}tournamentData.active=!0;tournamentData.config={mode:m,scoringMode:sm,tournamentName:tn};tournamentData.thirdPlace={p1:null,p2:null,score1:null,score2:null,winnerId:null,completed:!1};if(m==='groups_ko'){let gc=gID('group-count').value;const pl=participants.length;gc=gc==='auto'?(pl<=12?2:pl<=24?4:8):parseInt(gc);tournamentData.config.advancing=parseInt(gID('advancing-count').value);const mk=gID('group-ko-round').value;if(mk!=='auto')tournamentData.config.koTarget=parseInt(mk);tournamentData.currentStage='groups';if(autoMode){generateGroups(r,gc)}else{tournamentData.groups=[];manualData.slots.forEach((s,idx)=>{const groupMembers=s.items.map(pid=>{const p=participants.find(x=>x.id===pid);return{...p,stats:{p:0,w:0,d:0,l:0,gf:0,ga:0,gd:0}}});const ch="ABCDEFGHIJKLMNOPQRSTUVWXYZ";const grp={id:idx,name:`GRUPPE ${ch[idx]}`,participants:groupMembers,matches:[]};grp.matches=generateRoundRobinMatches(groupMembers,idx);tournamentData.groups.push(grp)});renderGroups()}let kc=gc*tournamentData.config.advancing;if(tournamentData.config.koTarget)kc=tournamentData.config.koTarget;const ph=[];for(let i=0;i<kc;i++)ph.push({id:`TBD_GR_${i}`,name:'TBD'});generateBracket(ph,kc)}else if(m==='release'){tournamentData.currentStage='release';tournamentData.release={scores:{},relegationScores:{}};r=JSON.parse(JSON.stringify(participants));r.forEach(p=>tournamentData.release.scores[p.id]=0)}else{tournamentData.currentStage='knockout';let tg=gID('ko-start-round').value;tg=tg==='auto'?Math.pow(2,Math.ceil(Math.log2(participants.length))):parseInt(tg);if(autoMode){generateBracket(r,tg)}else{let manualSorted=[];manualData.slots.forEach(s=>{if(s.items.length>0){const p=participants.find(x=>x.id===s.items[0]);manualSorted.push(p)}else{manualSorted.push({id:'BYE',name:'Freilos'})}});generateBracket(manualSorted,tg)}}updateUIState();if(m==='release'){switchTab('schedule');renderReleaseView();renderScheduleView()}else if(m==='groups_ko'){switchTab('schedule');renderScheduleView()}else{switchTab('schedule');renderBracket();renderScheduleView()}saveData()}
function renderReleaseView(){const c=gID('leaderboard-target');c.innerHTML='';let s=[...participants].sort((a,b)=>{const sa=parseInt(tournamentData.release.scores[a.id])||0,sb=parseInt(tournamentData.release.scores[b.id])||0;if(sa!==sb)return sa-sb;const ra=(tournamentData.release.relegationScores&&tournamentData.release.relegationScores[a.id])!==undefined?parseInt(tournamentData.release.relegationScores[a.id]):0,rb=(tournamentData.release.relegationScores&&tournamentData.release.relegationScores[b.id])!==undefined?parseInt(tournamentData.release.relegationScores[b.id]):0;return ra-rb});const CUT=16;let warn=!1,tids=[];if(s.length>CUT){const pa=s[CUT-1],pn=s[CUT],sca=parseInt(tournamentData.release.scores[pa.id])||0,scn=parseInt(tournamentData.release.scores[pn.id])||0;if(sca===scn){const ra=(tournamentData.release.relegationScores&&tournamentData.release.relegationScores[pa.id])||0,rn=(tournamentData.release.relegationScores&&tournamentData.release.relegationScores[pn.id])||0;if(ra===rn)warn=!0;tids=s.filter(p=>(parseInt(tournamentData.release.scores[p.id])||0)===sca).map(p=>p.id)}}let cd=!1;s.forEach((p,i)=>{const r=i+1,sc=tournamentData.release.scores[p.id]||0,q=r<=CUT,rel=tids.includes(p.id);if(r===CUT+1&&!cd){const sep=cE('div');sep.className='cut-separator';sep.innerHTML='<div class="cut-badge">‚ö†Ô∏è Top 16 Grenze</div>';c.appendChild(sep);cd=!0}const im=(p.img||imageRegistry[p.name])||D_IMG;let ri='';if(rel){const rs=(tournamentData.release.relegationScores&&tournamentData.release.relegationScores[p.id])||0;ri=`<div style="margin-left:20px;text-align:center;border-left:1px solid rgba(255,255,255,.1);padding-left:20px;"><div style="font-size:0.7rem;color:var(--gold);margin-bottom:5px;">REL</div><input type="number" value="${rs}" onchange="updateRelegationScore('${p.id}',this.value)" onkeypress="if(event.key==='Enter') refreshRanking()" style="width:90px;text-align:center;font-weight:bold;color:var(--gold);background:rgba(0,0,0,.2);border:1px solid rgba(251,191,36,.3);border-radius:4px;"></div>`}const ca=cE('div');ca.className=`leaderboard-row ${q?'qualified':'eliminated'}${rel&&warn?' relegation-tie':''}`;ca.innerHTML=`<div class="lb-rank">#${r}</div><img src="${im}" class="lb-img"><div class="lb-info"><div class="lb-name">${p.name}</div><div class="lb-status" style="color:var(--${q?'success':(rel?'gold':'text-muted')})">${q?'Qualifiziert':rel?'Relegation':'Ausgeschieden'}</div></div><div class="score-control-group"><button class="btn-score-adj" onclick="adjScore('${p.id}',-1)">-</button><input type="number" id="inp_score_${p.id}" class="score-display-input" value="${sc}" onchange="updateReleaseScore('${p.id}',this.value,0)" onkeypress="if(event.key==='Enter') refreshRanking()"><button class="btn-score-adj" onclick="adjScore('${p.id}',1)">+</button></div>${ri}`;c.appendChild(ca)});const b=gID('btn-release-advance');if(warn){b.className='btn btn-danger';b.innerText="‚ö†Ô∏è Gleichstand aufl√∂sen!";b.onclick=()=>alert("Relegation eintragen!")}else{b.className='btn btn-primary';b.innerText="üöÄ Top 16 Starten";b.onclick=advanceReleaseToBracket}}
function refreshRanking(){renderReleaseView()}
function adjScore(id,d){const c=parseInt(tournamentData.release.scores[id])||0;updateReleaseScore(id,c+d,0);gID(`inp_score_${id}`).value=c+d}
function updateReleaseScore(id,v,r=1){tournamentData.release.scores[id]=parseInt(v);saveData();if(r)renderReleaseView()}
function updateRelegationScore(id,v){if(!tournamentData.release.relegationScores)tournamentData.release.relegationScores={};tournamentData.release.relegationScores[id]=parseInt(v);saveData()}
function advanceReleaseToBracket(){if(!confirm("Starten?"))return;const s=[...participants].sort((a,b)=>{const sa=parseInt(tournamentData.release.scores[a.id])||0,sb=parseInt(tournamentData.release.scores[b.id])||0;if(sa!==sb)return sa-sb;return(tournamentData.release.relegationScores?tournamentData.release.relegationScores[a.id]||0:0)-(tournamentData.release.relegationScores?tournamentData.release.relegationScores[b.id]||0:0)}),t16=s.slice(0,16);if(t16.length<2)return alert("Zu wenige!");let sd=[];for(let i=0;i<8;i++){sd.push(t16[i]);sd.push(t16[15-i])}generateBracket(sd,16);tournamentData.currentStage='knockout';switchTab('bracket');updateUIState();saveData()}
function generateGroups(r,c){tournamentData.groups=[];const ch="ABCDEFGHIJKLMNOPQRSTUVWXYZ";for(let i=0;i<c;i++)tournamentData.groups.push({id:i,name:"GRUPPE "+ch[i],participants:[],matches:[]});r.forEach((p,i)=>tournamentData.groups[i%c].participants.push({...p,stats:{p:0,w:0,d:0,l:0,gf:0,ga:0,gd:0}}));tournamentData.groups.forEach(g=>{g.matches=generateRoundRobinMatches(g.participants,g.id)});renderGroups()}
function generateRoundRobinMatches(ps,gid){if(ps.length<2)return[];let matches=[];const n=ps.length;const isOdd=n%2===1;let rounds=isOdd?n:n-1;let map=[];for(let i=0;i<n;i++)map.push(i);if(isOdd)map.push(-1);const totalTeams=map.length;const half=totalTeams/2;for(let r=0;r<rounds;r++){for(let i=0;i<half;i++){const t1=map[i];const t2=map[totalTeams-1-i];if(t1!==-1&&t2!==-1){let p1=ps[t1],p2=ps[t2];if((r+i)%2===1){p1=ps[t2];p2=ps[t1]}matches.push({id:`g${gid}_m${r}_${i}`,p1:p1.id,p2:p2.id,score1:null,score2:null,played:!1,matchday:r+1})}}const fixed=map[0];const moving=map.slice(1);moving.unshift(moving.pop());map=[fixed,...moving]}return matches}
function renderGroups(){const c=gID('groups-display'),sp=tournamentData.config.scoringMode==='strokeplay';c.innerHTML='';tournamentData.groups.forEach(g=>{const s=[...g.participants].sort((a,b)=>{if(b.stats.p!==a.stats.p)return b.stats.p-a.stats.p;if(sp)return a.stats.gf-b.stats.gf;return(b.stats.gd-a.stats.gd)||(b.stats.gf-a.stats.gf)});const cd=cE('div');cd.className='group-card';let rs='';s.forEach((p,i)=>{const ad=i<tournamentData.config.advancing?'rank-advancing':'';rs+=`<tr class="${ad}"><td style="text-align:center;color:var(--text-muted);font-weight:bold;">${i+1}</td><td style="font-weight:600;color:#fff;">${p.name}</td><td style="text-align:center;">${p.stats.p}</td><td style="text-align:center;">${sp?p.stats.gf:p.stats.gf+':'+p.stats.ga}</td>${sp?'':`<td style="text-align:center;color:var(--text-muted);">${p.stats.gd}</td>`}</tr>`});let ms='';g.matches.sort((a,b)=>(a.matchday||0)-(b.matchday||0));let curMd=0;g.matches.forEach(m=>{const p1=g.participants.find(x=>x.id===m.p1),p2=g.participants.find(x=>x.id===m.p2);const md=m.matchday||1;if(md>curMd){ms+=`<div class="matchday-header">SPIELTAG ${md}</div>`;curMd=md}ms+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.05);"><span style="font-size:0.85rem;width:40%;text-align:right;">${colorName(p1.name,m.score1,m.score2)}</span><button onclick="openGroupMatchEdit('${g.id}','${m.id}')" style="background:var(--bg-dark);border:1px solid var(--accent-primary);color:var(--accent-glow);border-radius:4px;padding:2px 10px;cursor:pointer;">${colorScore(m.score1,m.score2)} : ${colorScore(m.score2,m.score1)}</button><span style="font-size:0.85rem;width:40%;">${colorName(p2.name,m.score2,m.score1)}</span></div>`});cd.innerHTML=`<div class="group-header">${g.name}</div><div style="padding:15px;"><table class="group-table"><thead><tr><th style="width:30px;">#</th><th>Team</th><th style="text-align:center">P</th><th style="text-align:center">${sp?"SuP":"MP"}</th>${sp?'':'<th style="text-align:center">Diff</th>'}</tr></thead><tbody>${rs}</tbody></table><div style="margin-top:15px;padding-top:10px;border-top:1px solid rgba(255,255,255,.1);">${ms}</div></div>`;c.appendChild(cd)})}
function generateBracket(ps,sz,sd=!1){tournamentData.bracket=[];let rnd=Math.log2(sz);for(let r=0;r<rnd;r++)tournamentData.bracket.push([]);let f=[...ps];while(f.length<sz)f.push({id:'BYE',name:'Freilos'});if(sd&&f.some(p=>p.sourceGroup!==undefined)){f.sort((a,b)=>{if(a.id==='BYE')return 1;if(b.id==='BYE')return -1;return a.sourceGroup-b.sourceGroup});const h=f.length/2,A=f.slice(0,h),B=f.slice(h).reverse();f=[];for(let i=0;i<h;i++){f.push(A[i]);f.push(B[i]||{id:'BYE',name:'Freilos'})}}for(let i=0;i<sz/2;i++){const p1=f[i*2],p2=f[i*2+1];let a=null,c=!1;if(p2.id==='BYE'){a=p1.id;c=!0}else if(p1.id==='BYE'){a=p2.id;c=!0}tournamentData.bracket[0].push({matchId:`r0_m${i}`,p1:p1.id,p2:p2.id,score1:null,score2:null,winnerId:a,completed:c})}let mc=sz/2;for(let r=1;r<rnd;r++){mc/=2;for(let m=0;m<mc;m++)tournamentData.bracket[r].push({matchId:`r${r}_m${m}`,p1:null,p2:null,score1:null,score2:null,winnerId:null,completed:!1})}tournamentData.bracket[0].forEach((m,x)=>{if(m.completed&&m.winnerId)advanceBracketWinner(0,x,m.winnerId)});renderBracket()}
function advanceBracketWinner(ri,mi,wid){if(ri+1>=tournamentData.bracket.length)return;const isSf=(ri===tournamentData.bracket.length-2);if(isSf){const cm=tournamentData.bracket[ri][mi],lid=(wid===cm.p1)?cm.p2:cm.p1;if(mi===0)tournamentData.thirdPlace.p1=lid;else tournamentData.thirdPlace.p2=lid}const nm=tournamentData.bracket[ri+1][Math.floor(mi/2)];if(mi%2===0)nm.p1=wid;else nm.p2=wid;if(nm.p1&&nm.p2){const p1=getParticipant(nm.p1),p2=getParticipant(nm.p2);if(p1&&p1.id==='BYE'){nm.winnerId=nm.p2;nm.completed=!0;advanceBracketWinner(ri+1,Math.floor(mi/2),nm.p2)}if(p2&&p2.id==='BYE'){nm.winnerId=nm.p1;nm.completed=!0;advanceBracketWinner(ri+1,Math.floor(mi/2),nm.p1)}}}
function renderBracket(){const c=gID('bracket-display');c.innerHTML='';if(tournamentData.bracketBg){const bgl=cE('div');bgl.className='bracket-bg-layer';bgl.style.backgroundImage=`url('${tournamentData.bracketBg}')`;c.appendChild(bgl)}if(!tournamentData.bracket||tournamentData.bracket.length===0)return;renderSplitBracket(c);setTimeout(fitBracketToScreen,0)}
function fitBracketToScreen(){const cnt=gID('bracket-display');if(!cnt)return;const inner=cnt.querySelector('.bracket-split-container')||cnt.querySelector('.round-col')?.parentNode;if(!inner)return;const pad=40;const avW=cnt.clientWidth-pad,avH=cnt.clientHeight-pad;inner.style.transform='none';const realW=inner.scrollWidth,realH=inner.scrollHeight;if(realW<=0||realH<=0)return;const sc=Math.min(Math.min(avW/realW,avH/realH),1);inner.style.transform=`scale(${sc})`}
function renderSplitBracket(c){const wrapper=cE('div');wrapper.className='bracket-split-container';const rounds=tournamentData.bracket.length;if(rounds>=5)wrapper.classList.add('bracket-scale-32');else if(rounds==4)wrapper.classList.add('bracket-scale-16');else if(rounds==3)wrapper.classList.add('bracket-scale-8');const left=cE('div'),right=cE('div'),center=cE('div');left.className='side-block bracket-left';right.className='side-block bracket-right';center.className='center-block';right.style.flexDirection='row-reverse';const finalIdx=rounds-1;const splitRounds=rounds-1;const rn=["Halbfinale","Viertelfinale","Achtelfinale","Runde der 32","Runde der 64"];for(let r=0;r<splitRounds;r++){const matches=tournamentData.bracket[r];const mid=matches.length/2;const leftMs=matches.slice(0,mid);const rightMs=matches.slice(mid);const nm=rn[splitRounds-1-r]||`Runde ${r+1}`;const colL=cE('div');colL.className='round-col';colL.innerHTML=`<div class="round-header">${nm}</div>`;if(r<splitRounds-1){for(let i=0;i<leftMs.length;i+=2){const pair=cE('div');pair.className='match-pair';pair.appendChild(createMatchCard(leftMs[i],r,i,!0,!1));if(leftMs[i+1])pair.appendChild(createMatchCard(leftMs[i+1],r,i+1,!0,!1));colL.appendChild(pair)}}else{leftMs.forEach((m,i)=>{const pair=cE('div');pair.className='match-single';pair.appendChild(createMatchCard(m,r,i,!0,!1));colL.appendChild(pair)})}left.appendChild(colL);const colR=cE('div');colR.className='round-col';colR.innerHTML=`<div class="round-header">${nm}</div>`;if(r<splitRounds-1){for(let i=0;i<rightMs.length;i+=2){const pair=cE('div');pair.className='match-pair';pair.appendChild(createMatchCard(rightMs[i],r,i+mid,!0,!0));if(rightMs[i+1])pair.appendChild(createMatchCard(rightMs[i+1],r,i+1+mid,!0,!0));colR.appendChild(pair)}}else{rightMs.forEach((m,i)=>{const pair=cE('div');pair.className='match-single';pair.appendChild(createMatchCard(m,r,i+mid,!0,!0));colR.appendChild(pair)})}right.appendChild(colR)}const fM=tournamentData.bracket[finalIdx][0];const finalCard=createMatchCard(fM,finalIdx,0,!0,!1);finalCard.classList.add('has-champion');center.innerHTML=`<div style="text-align:center"><div class="round-header" style="font-size:1.5rem;color:var(--accent-glow);margin-bottom:20px;">FINALE</div></div><div class="final-connector-left"></div><div class="final-connector-right"></div>`;center.appendChild(finalCard);if(tournamentData.thirdPlace){const tpCard=createThirdPlaceCard();tpCard.style.marginTop='20px';tpCard.style.borderColor='var(--gold)';center.appendChild(tpCard)}wrapper.appendChild(left);wrapper.appendChild(center);wrapper.appendChild(right);c.appendChild(wrapper)}
function createMatchCard(m,ri,mi,isSplit,isMirror){const p1=getParticipant(m.p1),p2=getParticipant(m.p2),c=cE('div');c.className='match-card';if(ri===tournamentData.bracket.length-1&&m.completed&&m.winnerId)c.classList.add('has-champion');if(p1&&p1.id!=='BYE')c.dataset.team1=p1.id;if(p2&&p2.id!=='BYE')c.dataset.team2=p2.id;const s1=colorScore(m.score1,m.score2),s2=colorScore(m.score2,m.score1),w1=m.winnerId===m.p1?'winner':'',w2=m.winnerId===m.p2?'winner':'',rt=(p,s,wc)=>{const i=p&&(p.img||imageRegistry[p.name])?p.img||imageRegistry[p.name]:null,tg=i?`<img src="${i}" class="team-img">`:`<div class="team-img" style="display:flex;justify-content:center;align-items:center;font-size:0.6rem;">?</div>`,n=p?p.name:'TBD',me=getMedal(p?p.id:null);return`<div class="match-team ${wc}" data-tid="${p?p.id:''}"><div class="team-info">${tg}<div class="team-name">${n} ${me}</div></div><div class="team-score">${s}</div></div>`};c.innerHTML=`<div class="champion-icon">üëë</div>${rt(p1,s1,w1)}<div class="match-vs">VS</div>${rt(p2,s2,w2)}`;if(p1&&p2&&!m.completed&&p1.id.indexOf('TBD')===-1&&p2.id.indexOf('TBD')===-1)c.onclick=()=>openBracketMatchEdit(ri,mi);else if(m.completed)c.onclick=()=>openBracketMatchEdit(ri,mi);c.onmouseenter=()=>highlightTrace(p1?.id,p2?.id);c.onmouseleave=()=>clearTrace();return c}
function createThirdPlaceCard(){const m=tournamentData.thirdPlace,p1=getParticipant(m.p1),p2=getParticipant(m.p2),cd=cE('div');cd.className='match-card';const s1=colorScore(m.score1,m.score2),s2=colorScore(m.score2,m.score1),rt=(p,s,wc)=>{const i=p&&(p.img||imageRegistry[p.name])?p.img||imageRegistry[p.name]:null,tg=i?`<img src="${i}" class="team-img">`:`<div class="team-img" style="display:flex;justify-content:center;align-items:center;font-size:0.6rem;">?</div>`,n=p?p.name:'TBD',me=getMedal(p?p.id:null);return`<div class="match-team ${wc}"><div class="team-info">${tg}<div class="team-name">${n} ${me}</div></div><div class="team-score">${s}</div></div>`};const w1=m.winnerId===m.p1&&m.completed?'winner':'',w2=m.winnerId===m.p2&&m.completed?'winner':'';cd.innerHTML=`<div style="position:absolute;top:-20px;width:100%;text-align:center;font-size:0.7rem;color:var(--gold);">ü•â BRONZE MATCH</div>${rt(p1,s1,w1)}<div class="match-vs">VS</div>${rt(p2,s2,w2)}`;if(p1&&p2&&!m.completed)cd.onclick=()=>openThirdPlaceEdit();else if(m.completed)cd.onclick=()=>openThirdPlaceEdit();return cd}
function highlightTrace(i1,i2){if(!i1&&!i2)return;const cs=d.querySelectorAll('.match-card'),ts=d.querySelectorAll('.match-team');[i1,i2].filter(x=>x&&x!=='BYE').forEach(id=>{cs.forEach(c=>{if(c.dataset.team1===id||c.dataset.team2===id)c.classList.add('trace-active')});ts.forEach(t=>{if(t.dataset.tid===id)t.classList.add('trace-team')})})}
function clearTrace(){d.querySelectorAll('.trace-active').forEach(e=>e.classList.remove('trace-active'));d.querySelectorAll('.trace-team').forEach(e=>e.classList.remove('trace-team'))}
function openGroupMatchEdit(g,m){const gr=tournamentData.groups.find(x=>x.id==g),ma=gr.matches.find(x=>x.id==m);setupModal(getParticipant(ma.p1).name,getParticipant(ma.p2).name,ma.score1,ma.score2,!1);currentMatchIdEdit={type:'group',gId:g,mId:m}}
function openBracketMatchEdit(r,m){const ma=tournamentData.bracket[r][m];if(!ma.p1||!ma.p2)return;setupModal(getParticipant(ma.p1).name,getParticipant(ma.p2).name,ma.score1,ma.score2,!0);currentMatchIdEdit={type:'bracket',rIdx:r,mIdx:m}}
function openThirdPlaceEdit(){const m=tournamentData.thirdPlace;if(!m.p1||!m.p2)return;setupModal(getParticipant(m.p1).name,getParticipant(m.p2).name,m.score1,m.score2,!0);currentMatchIdEdit={type:'thirdPlace'}}
function setupModal(n1,n2,s1,s2,ko){gID('m-p1-name').innerText=n1;gID('m-p2-name').innerText=n2;gID('m-score1').value=s1!==null?s1:0;gID('m-score2').value=s2!==null?s2:0;gID('penalty-section').style.display=ko?'block':'none';d.querySelectorAll('input[name="winner-force"]').forEach(r=>r.checked=!1);gID('match-modal').style.display='flex'}
function saveMatchResult(){const s1=parseInt(gID('m-score1').value),s2=parseInt(gID('m-score2').value);if(isNaN(s1)||isNaN(s2))return;const sp=(tournamentData.config.mode==='release')||(tournamentData.config.scoringMode==='strokeplay'),det=(a,b)=>{if(a===b)return'draw';if(sp)return a<b?'p1':'p2';return a>b?'p1':'p2'};if(currentMatchIdEdit.type==='group'){const g=tournamentData.groups.find(x=>x.id==currentMatchIdEdit.gId),m=g.matches.find(x=>x.id==currentMatchIdEdit.mId);m.score1=s1;m.score2=s2;m.played=!0;recalcGroupStats(g);renderGroups();checkGroupCompletion()}else if(currentMatchIdEdit.type==='thirdPlace'){const m=tournamentData.thirdPlace;m.score1=s1;m.score2=s2;const w=det(s1,s2);if(w==='draw'){let f=null;d.querySelectorAll('input[name="winner-force"]').forEach(r=>{if(r.checked)f=r.value});if(!f)return alert("Sieger?");m.winnerId=f==="1"?m.p1:m.p2}else m.winnerId=w==='p1'?m.p1:m.p2;m.completed=!0;renderBracket()}else{const m=tournamentData.bracket[currentMatchIdEdit.rIdx][currentMatchIdEdit.mIdx];m.score1=s1;m.score2=s2;const w=det(s1,s2);if(w==='draw'){let f=null;d.querySelectorAll('input[name="winner-force"]').forEach(r=>{if(r.checked)f=r.value});if(!f)return alert("Sieger?");m.winnerId=f==="1"?m.p1:m.p2}else m.winnerId=w==='p1'?m.p1:m.p2;m.completed=!0;advanceBracketWinner(currentMatchIdEdit.rIdx,currentMatchIdEdit.mIdx,m.winnerId);renderBracket()}closeMatchModal();saveData()}
function closeMatchModal(){gID('match-modal').style.display='none'}
function recalcGroupStats(g){g.participants.forEach(p=>p.stats={p:0,w:0,d:0,l:0,gf:0,ga:0,gd:0});const sp=tournamentData.config.scoringMode==='strokeplay';g.matches.forEach(m=>{if(!m.played)return;const p1=g.participants.find(x=>x.id==m.p1),p2=g.participants.find(x=>x.id==m.p2);p1.stats.gf+=m.score1;p1.stats.ga+=m.score2;p1.stats.gd=p1.stats.gf-p1.stats.ga;p2.stats.gf+=m.score2;p2.stats.ga+=m.score1;p2.stats.gd=p2.stats.gf-p2.stats.ga;let w1=!1,w2=!1;if(sp){if(m.score1<m.score2)w1=!0;else if(m.score2<m.score1)w2=!0}else{if(m.score1>m.score2)w1=!0;else if(m.score2>m.score1)w2=!0}if(w1){p1.stats.p+=3;p1.stats.w++;p2.stats.l++}else if(w2){p2.stats.p+=3;p2.stats.w++;p1.stats.l++}else{p1.stats.p++;p2.stats.p++;p1.stats.d++;p2.stats.d++}})}
function checkGroupCompletion(){let a=!0;tournamentData.groups.forEach(g=>{if(g.matches.some(x=>!x.played))a=!1});gID('btn-advance-ko').style.display=a?'block':'none';renderGroups()}
function advanceToKnockout(){if(!confirm("K.O. Phase?"))return;const sp=tournamentData.config.scoringMode==='strokeplay';let q=[];tournamentData.groups.forEach(g=>{const s=[...g.participants].sort((a,b)=>{if(b.stats.p!==a.stats.p)return b.stats.p-a.stats.p;if(sp)return a.stats.gf-b.stats.gf;return(b.stats.gd-a.stats.gd)||(b.stats.gf-a.stats.gf)});for(let i=0;i<tournamentData.config.advancing;i++)if(s[i])q.push({...s[i],sourceGroup:g.id})});let sz=2;if(q.length>2)sz=4;if(q.length>4)sz=8;if(q.length>8)sz=16;if(q.length>16)sz=32;if(tournamentData.config.koTarget){sz=tournamentData.config.koTarget;if(q.length>sz)q=q.slice(0,sz)}generateBracket(q,sz,!0);tournamentData.currentStage='knockout';switchTab('bracket');updateUIState();saveData()}
function getParticipant(id){if(!id)return null;if(id==='BYE')return{id:'BYE',name:'Freilos'};let p=participants.find(x=>x.id===id);if(!p)tournamentData.groups.forEach(g=>{const f=g.participants.find(x=>x.id===id);if(f)p=f});if(id.startsWith('TBD'))return{id:id,name:'TBD'};return p}
function updateUIState(){const b=gID('nav-bracket'),g=gID('nav-groups'),r=gID('nav-release'),s=gID('nav-schedule'),a=gID('nav-assignment');g.style.display='none';b.style.display='none';r.style.display='none';s.style.display='none';a.style.display='none';if(tournamentData.active){s.style.display='inline-block';if(tournamentData.config.mode==='groups_ko'){g.style.display='inline-block';b.style.display='inline-block'}else if(tournamentData.config.mode==='release'){r.style.display='inline-block';b.style.display='inline-block'}else{b.style.display='inline-block'}}else if(participants.length>0&&gID('assignment-mode').value==='manual'&&gID('view-assignment').classList.contains('active')){a.style.display='inline-block'}}
function formatTimeDE(iso){if(!iso)return'TBA';const d=new Date(iso);return isNaN(d.getTime())?iso:d.toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric'})+', '+d.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'})+' Uhr'}
function formatDateDE(iso){if(!iso)return'TBA';const d=new Date(iso);return isNaN(d.getTime())?iso:d.toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric'})}
function renderScheduleView(){const l=gID('schedule-list'),m=tournamentData.config.mode;gID('tourn-start-date').value=tournamentData.schedule.start||'';gID('tourn-end-date').value=tournamentData.schedule.end||'';l.innerHTML='';const row=(id,lbl,idx=null)=>{const t=tournamentData.schedule.config[id]||'range',vs=tournamentData.schedule.phases[id+'_start']||'',ve=tournamentData.schedule.phases[id+'_end']||'',vf=tournamentData.schedule.phases[id]||'';let inp='';if(t==='range'){inp=`<input type="date" id="${id}_start" class="schedule-input" value="${vs}" onchange="savePhaseInput('${id}_start',this.value)"><span style="color:var(--text-muted)">bis</span><input type="date" id="${id}_end" class="schedule-input" value="${ve}" onchange="savePhaseInput('${id}_end',this.value)">`}else if(t==='fixed'){const ass=tournamentData.schedule.streamerAssignments&&tournamentData.schedule.streamerAssignments[id]?tournamentData.schedule.streamerAssignments[id]:'';inp=`<div style="display:flex;gap:5px;width:100%"><input type="datetime-local" id="${id}" class="schedule-input" value="${vf}" onchange="savePhaseInput('${id}',this.value)">${getStreamerSelect(id,ass)}</div>`}else if(t==='detailed'&&idx!==null&&m!=='release'){const roundMatches=tournamentData.bracket[idx]||[];if(roundMatches.length===0){inp=`<div style="padding:10px; color:var(--text-muted); font-style:italic;">Matches noch nicht generiert.</div>`}else{let html='<div class="detailed-schedule-grid">';const tr=tournamentData.bracket.length;const rev=tr-1-idx;let prefix="Spiel";if(rev===0)prefix="Finale";else if(rev===1)prefix="HF";else if(rev===2)prefix="VF";else if(rev===3)prefix="AF";else prefix="R"+Math.pow(2,rev+1);roundMatches.forEach((m,midx)=>{const mk=`sched_match_${m.matchId}_time`;const mv=tournamentData.schedule.phases[mk]||'';const ass=tournamentData.schedule.streamerAssignments&&tournamentData.schedule.streamerAssignments[mk]?tournamentData.schedule.streamerAssignments[mk]:'';const p1=getParticipant(m.p1),p2=getParticipant(m.p2);const n1=p1?p1.name:'TBD',n2=p2?p2.name:'TBD';html+=`<div class="detailed-match-item"><div class="detailed-match-title">${prefix} ${midx+1}: ${n1} vs ${n2}</div><input type="datetime-local" class="schedule-input" style="margin-bottom:5px" value="${mv}" onchange="savePhaseInput('${mk}',this.value)">${getStreamerSelect(mk,ass)}</div>`});html+='</div>';inp=html}}let opts=`<option value="range" ${t==='range'?'selected':''}>Zeitraum (Von-Bis)</option><option value="fixed" ${t==='fixed'?'selected':''}>Zeitpunkt (Fix)</option>`;if(idx!==null&&m!=='release'){opts+=`<option value="detailed" ${t==='detailed'?'selected':''}>Einzelne Ansetzungen</option>`}return`<div class="schedule-row"><div class="schedule-label">${lbl}</div><div class="schedule-inputs-wrapper"><select class="schedule-mode-select" onchange="toggleScheduleMode('${id}',this.value)">${opts}</select>${inp}</div><button class="btn btn-primary" style="width:auto; padding:5px 10px; margin:0;" onclick="manualSaveSchedule()">üíæ √úbernehmen</button></div>`};let h='';if(m==='groups_ko'){let gc=parseInt(gID('group-count').value);if(isNaN(gc)&&tournamentData.groups.length>0)gc=tournamentData.groups.length;if(isNaN(gc))gc=1;let maxP=0;if(tournamentData.groups.length>0){tournamentData.groups.forEach(g=>{if(g.participants.length>maxP)maxP=g.participants.length})}else if(participants.length>0){maxP=Math.ceil(participants.length/gc)}let matchdays=(maxP<2)?1:((maxP%2===0)?maxP-1:maxP);for(let i=1;i<=matchdays;i++)h+=row(`sched_g_md${i}`,`Gruppenphase - Spieltag ${i}`);let adv=parseInt(gID('advancing-count').value)||2;let koTeams=gc*adv;let koRounds=Math.ceil(Math.log2(koTeams));for(let i=0;i<koRounds;i++){const rn=getRoundName(i,koRounds);if(rn==="Finale")continue;h+=row(`sched_ko_r${i}`,rn,i)}h+=row('sched_third_place','Spiel um Platz 3');h+=row(`sched_ko_r${koRounds-1}`,'Finale',koRounds-1)}else if(m==='release'){h+=row('sched_rel_qual','Qualifikation');for(let x=1;x<=8;x++)h+=row(`sched_rel_af_${x}`,`Achtelfinale ${x}`);for(let x=1;x<=4;x++)h+=row(`sched_rel_vf_${x}`,`Viertelfinale ${x}`);h+=row(`sched_rel_sf_1`,`Halbfinale 1`);h+=row(`sched_rel_sf_2`,`Halbfinale 2`);h+=row('sched_third_place','Spiel um Platz 3');h+=row(`sched_rel_final`,`Finale`)}else{let startRound=gID('ko-start-round').value;let tg=startRound==='auto'?Math.pow(2,Math.ceil(Math.log2(participants.length||2))):parseInt(startRound);let rounds=Math.log2(tg);for(let i=0;i<rounds;i++){const rn=getRoundName(i,rounds);if(rn==="Finale")continue;h+=row(`sched_ko_r${i}`,rn,i)}h+=row('sched_third_place','Spiel um Platz 3');h+=row(`sched_ko_r${rounds-1}`,'Finale',rounds-1)}l.innerHTML=h}
function getStreamerSelect(id,val){let s=`<select class="schedule-input" style="max-width:150px" onchange="saveStreamerAssignment('${id}',this.value)"><option value="">-- Streamer --</option>`;streamers.forEach(st=>{s+=`<option value="${st.id}" ${val===st.id?'selected':''}>${st.name}</option>`});s+='</select>';return s}
function saveStreamerAssignment(id,val){if(!tournamentData.schedule.streamerAssignments)tournamentData.schedule.streamerAssignments={};tournamentData.schedule.streamerAssignments[id]=val;saveData()}
function updateExportIfActive(){if(gID('view-export').classList.contains('active'))renderExport(currentExportState.t,currentExportState.id)}
function renderExport(t,gid=null,targetId=null){if(!targetId)currentExportState={t,id:gid};const ct=gID(targetId||'export-content');if(!targetId){const st=gID('export-subtitle'),tl=gID('export-title'),bg=gID('export-bg-layer');ct.innerHTML='';st.innerHTML='';bg.style.backgroundImage=tournamentData.bracketBg?`url('${tournamentData.bracketBg}')`:'none';tl.innerText=(tournamentData.config.tournamentName||"Turnier").toUpperCase()}else{ct.innerHTML=''}if(t==='groups'){const c=gID('groups-display').cloneNode(!0);c.querySelectorAll('button').forEach(b=>{const s=cE('span');s.innerHTML=b.innerHTML;s.style.fontWeight='bold';b.replaceWith(s)});c.style.gridTemplateColumns="1fr 1fr";if(targetId)c.style.gridTemplateColumns="1fr";ct.appendChild(c);if(!targetId)gID('export-subtitle').innerText="GRUPPEN PHASE"}else if(t==='single_group'){const gd=tournamentData.groups.find(g=>g.id==gid);if(gd){const oc=gID('groups-display'),cards=oc.getElementsByClassName('group-card'),tc=cards[gid].cloneNode(!0);tc.querySelectorAll('button').forEach(b=>{const s=cE('span');s.innerHTML=b.innerHTML;s.style.fontWeight='bold';b.replaceWith(s)});tc.style.width="90%";tc.style.margin="20px auto";tc.style.fontSize="1.3em";ct.appendChild(tc);if(!targetId)gID('export-subtitle').innerText=gd.name}}else if(t==='release'){const c=gID('leaderboard-target').cloneNode(!0);c.querySelectorAll('.btn-score-adj').forEach(e=>e.remove());c.querySelectorAll('.score-display-input').forEach(i=>{const s=cE('span');s.innerText=i.value;s.style.cssText="font-family: var(--font-headings); font-size: 2.5rem; font-weight: bold; color: var(--text-main); padding: 0 10px;";i.replaceWith(s)});c.querySelectorAll('input[type="number"]').forEach(i=>{const s=cE('span');s.innerText=i.value;s.style.color='var(--gold)';s.style.fontWeight='bold';s.style.fontSize='1.2rem';i.replaceWith(s)});c.querySelectorAll('.lb-img').forEach(i=>{i.style.width="70px";i.style.height="70px";i.style.objectFit="cover";i.style.flexShrink="0"});c.querySelectorAll('.score-control-group').forEach(e=>{e.style.border='none';e.style.background='transparent';e.style.justifyContent='center'});ct.appendChild(c);if(!targetId)gID('export-subtitle').innerText="RANKING"}else if(t==='bracket'){const b=gID('bracket-display').cloneNode(!0);const innerBg=b.querySelector('.bracket-bg-layer');if(innerBg)innerBg.remove();b.style.overflow='visible';const bsc=b.querySelector('.bracket-split-container');if(bsc){bsc.style.transform='none';if(!targetId){ct.style.width="fit-content";ct.style.minWidth="1000px"}}ct.appendChild(b);if(!targetId)gID('export-subtitle').innerText="TURNIERBAUM"}else if(t==='schedule'){if(!targetId)gID('export-subtitle').innerText="ZEITPLAN";const g=cE('div');g.className="export-sched-grid";const gM=id=>{if(id==='sched_third_place')return tournamentData.thirdPlace;if(!tournamentData.bracket||tournamentData.bracket.length===0)return null;const rn=tournamentData.bracket.length;if(id==='sched_sf1')return tournamentData.bracket[rn-2]?tournamentData.bracket[rn-2][0]:null;if(id==='sched_sf2')return tournamentData.bracket[rn-2]?tournamentData.bracket[rn-2][1]:null;if(id==='sched_final'||id===`sched_ko_r${rn-1}`)return tournamentData.bracket[rn-1]?tournamentData.bracket[rn-1][0]:null;if(id==='sched_rel_sf_1')return tournamentData.bracket[2]?tournamentData.bracket[2][0]:null;if(id==='sched_rel_sf_2')return tournamentData.bracket[2]?tournamentData.bracket[2][1]:null;if(id==='sched_rel_final')return tournamentData.bracket[3]?tournamentData.bracket[3][0]:null;if(id.startsWith('sched_ko_r'))return null;if(id.startsWith('sched_rel_af_')||id.startsWith('sched_ko_af_')){const x=parseInt(id.split('_').pop())-1;if(tournamentData.config.mode==='release')return tournamentData.bracket[0][x];return tournamentData.bracket[rn-4][x]}if(id.startsWith('sched_rel_vf_')||id.startsWith('sched_ko_vf_')){const x=parseInt(id.split('_').pop())-1;if(tournamentData.config.mode==='release')return tournamentData.bracket[1][x];return tournamentData.bracket[rn-3][x]}return null};const gS=(id,bIdx,mIdx)=>{if(id==='sched_third_place'){const t=tournamentData.thirdPlace;if(t.completed)return'done';if(t.p1&&t.p2)return'running';return'pending'}if(id==='sched_rel_qual')return tournamentData.currentStage==='knockout'?'done':'running';if(id.startsWith('sched_g_md')){const md=parseInt(id.replace('sched_g_md',''));let tot=0,played=0;tournamentData.groups.forEach(g=>{g.matches.forEach(m=>{if((m.matchday||1)===md){tot++;if(m.played)played++}})});if(tot>0&&tot===played)return'done';if(played>0)return'running';if(md===1)return'running';let pt=0,pp=0;tournamentData.groups.forEach(g=>{g.matches.forEach(m=>{if((m.matchday||1)===md-1){pt++;if(m.played)pp++}})});if(pt>0&&pt===pp)return'running';return'pending'}let r=bIdx;if(r===null&&id.startsWith('sched_ko_r'))r=parseInt(id.replace('sched_ko_r',''));if(r!==null&&tournamentData.bracket[r]){const ms=tournamentData.bracket[r];if(mIdx!==null){const sm=ms[mIdx];if(!sm)return'pending';if(sm.completed)return'done';if(sm.p1&&!sm.p1.startsWith('TBD')&&sm.p2&&!sm.p2.startsWith('TBD'))return'running';return'pending'}if(!ms||ms.length===0)return'pending';const completed=ms.filter(m=>m.completed).length;if(completed===ms.length)return'done';if(completed>0)return'running';if(r===0){if(tournamentData.config.mode==='groups_ko'&&tournamentData.currentStage!=='knockout')return'pending';return'running'}const prevMs=tournamentData.bracket[r-1];if(prevMs&&prevMs.every(m=>m.completed))return'running';return'pending'}return'pending'};const getStH=(id)=>{if(!tournamentData.schedule.streamerAssignments||!tournamentData.schedule.streamerAssignments[id])return'';const sid=tournamentData.schedule.streamerAssignments[id];const s=streamers.find(x=>x.id===sid);if(!s)return'';let p='';if(s.platforms.includes('yt'))p+=`<span class="st-icon-yt" title="YouTube"><img src="${streamerConfig.ytLogo||D_YT}" style="width:40px;height:40px;vertical-align:middle;margin-left:5px"></span>`;if(s.platforms.includes('tw'))p+=`<span class="st-icon-tw" title="Twitch"><img src="${streamerConfig.twLogo||D_TW}" style="width:40px;height:40px;vertical-align:middle;margin-left:5px"></span>`;return`<div style="display:flex;flex-direction:column;justify-content:center;align-items:center;margin-left:30px;"><div class="st-export-label" style="font-size:0.6rem;line-height:1;margin-bottom:2px">WIRD GESTREAMT BEI:</div><div class="streamer-display" style="font-size:1.1rem;padding:5px 12px"><img src="${s.img||D_IMG}" style="width:24px;height:24px;border-radius:50%;margin-right:5px;vertical-align:middle">${s.name}${p}</div></div>`};const add=(lbl,id,pid=null,cl='',bracketIdx=null,matchIdx=null)=>{const r=cE('div');r.className="export-sched-row";const cid=pid||id,ty=tournamentData.schedule.config[cid]||'range',s=tournamentData.schedule.phases[`${cid}_start`],e=tournamentData.schedule.phases[`${cid}_end`],f=tournamentData.schedule.phases[cid];let tm='',st=gS(cid,bracketIdx,matchIdx);if(ty==='detailed'&&bracketIdx!==null&&tournamentData.config.mode!=='release'){const roundMatches=tournamentData.bracket[bracketIdx]||[];let listHtml='';const tr=tournamentData.bracket.length;const rev=tr-1-bracketIdx;let prefix="Spiel";if(rev===0)prefix="Finale";else if(rev===1)prefix="HF";else if(rev===2)prefix="VF";else if(rev===3)prefix="AF";else prefix="R"+Math.pow(2,rev+1);if(matchIdx!==null){const m=roundMatches[matchIdx];if(m){const mk=`sched_match_${m.matchId}_time`;const mv=tournamentData.schedule.phases[mk];const p1=getParticipant(m.p1),p2=getParticipant(m.p2);const n1=p1?p1.name:'TBD',n2=p2?p2.name:'TBD';const m1=getMedal(p1?p1.id:null),m2=getMedal(p2?p2.id:null);const timeStr=mv?formatTimeDE(mv):'TBA';let scoreStr=m.completed?`<b>${colorScore(m.score1,m.score2)} : ${colorScore(m.score2,m.score1)}</b>`:'vs';let tmDisplay=mv?`<span>‚è∞</span> ${formatTimeDE(mv)}`:`<span>‚è≥</span> TBA`;let stM='pending';if(m.completed)stM='done';else if(m.p1&&!m.p1.startsWith('TBD')&&m.p2&&!m.p2.startsWith('TBD'))stM='running';let bM='',txtM='';if(stM==='done'){bM='status-done';txtM='Abgeschlossen'}else if(stM==='running'){bM='status-running';txtM='Laufend'}else{bM='status-pending';txtM='Ausstehend'}let badgeM=`<span class="status-badge ${bM}">${txtM}</span>`;const stHTML=getStH(mk);listHtml=`<div style="padding:15px 0; border-bottom:1px solid rgba(255,255,255,0.1);"><div class="export-sched-time" style="display:flex;align-items:center">${tmDisplay}${stHTML}</div><div class="export-match-detail" style="border:none; padding-top:5px;">${badgeM}<span style="display:block; margin-top:4px; font-size:1.1rem; font-weight:600;">${n1}${m1} ${scoreStr} ${n2}${m2}</span></div></div>`}}else{roundMatches.forEach((m,midx)=>{const mk=`sched_match_${m.matchId}_time`;const mv=tournamentData.schedule.phases[mk];const p1=getParticipant(m.p1),p2=getParticipant(m.p2);const n1=p1?p1.name:'TBD',n2=p2?p2.name:'TBD';const m1=getMedal(p1?p1.id:null),m2=getMedal(p2?p2.id:null);const timeStr=mv?formatTimeDE(mv):'TBA';let scoreStr=m.completed?`<b>${colorScore(m.score1,m.score2)} : ${colorScore(m.score2,m.score1)}</b>`:'vs';let tmDisplay=mv?`<span>‚è∞</span> ${formatTimeDE(mv)}`:`<span>‚è≥</span> TBA`;let stM='pending';if(m.completed)stM='done';else if(m.p1&&!m.p1.startsWith('TBD')&&m.p2&&!m.p2.startsWith('TBD'))stM='running';let bM='',txtM='';if(stM==='done'){bM='status-done';txtM='Abgeschlossen'}else if(stM==='running'){bM='status-running';txtM='Laufend'}else{bM='status-pending';txtM='Ausstehend'}let badgeM=`<span class="status-badge ${bM}">${txtM}</span>`;const stHTML=getStH(mk);listHtml+=`<div style="padding:15px 0; border-bottom:1px solid rgba(255,255,255,0.1);"><div class="export-sched-time" style="display:flex;align-items:center">${tmDisplay}${stHTML}</div><div class="export-match-detail" style="border:none; padding-top:5px;">${badgeM}<span style="display:block; margin-top:4px; font-size:1.1rem; font-weight:600;">${n1}${m1} ${scoreStr} ${n2}${m2}</span></div></div>`})}r.innerHTML=`<div class="export-sched-label ${cl}">${lbl}</div><div class="export-sched-val" style="display:block; padding:0 25px;">${listHtml}</div>`;g.appendChild(r);return}let specificTime=null;if(bracketIdx!==null&&matchIdx!==null){const br=tournamentData.bracket[bracketIdx];if(br&&br[matchIdx]){const m=br[matchIdx];specificTime=tournamentData.schedule.phases[`sched_match_${m.matchId}_time`]}}if(specificTime){tm=`<span>‚è∞</span> ${formatTimeDE(specificTime)}`}else{let timeVal=null;if(!timeVal)timeVal=tournamentData.schedule.phases[id];if(!timeVal&&pid)timeVal=tournamentData.schedule.phases[pid];if(timeVal){tm=`<span>‚è∞</span> ${formatTimeDE(timeVal)}`}else{if(ty==='range'){tm=(s&&e)?`<span>üìÖ</span> ${formatDateDE(s)} &mdash; ${formatDateDE(e)}`:'<span>‚è≥</span> TBA'}else{tm=f?`<span>‚è∞</span> ${formatTimeDE(f)}`:'<span>‚è≥</span> TBA'}}}let det='',b='',txt='';if(st==='done'){b='status-done';txt='Abgeschlossen'}else if(st==='running'){b='status-running';txt='Laufend'}else{b='status-pending';txt='Ausstehend'}const mo=gM(id);const stHTML=getStH(id);if(mo){const p1=getParticipant(mo.p1),p2=getParticipant(mo.p2),n1=p1?p1.name:'TBD',n2=p2?p2.name:'TBD',m1=getMedal(p1?p1.id:null),m2=getMedal(p2?p2.id:null);let badge=`<span class="status-badge ${b}">${txt}</span>`;det=`<div class="export-match-detail">${badge} ${n1}${m1} <b>${colorScore(mo.score1,mo.score2)} : ${colorScore(mo.score2,mo.score1)}</b> ${n2}${m2}</div>`}else{det=`<div class="export-match-detail"><span class="status-badge ${b}">${txt}</span></div>`}r.innerHTML=`<div class="export-sched-label ${cl}">${lbl}</div><div class="export-sched-val"><div class="export-sched-time" style="display:flex;align-items:center">${tm} ${stHTML}</div>${det}</div>`;g.appendChild(r)};const m=tournamentData.config.mode;if(m==='groups_ko'){for(let i=1;i<=calculateGroupMatchdays();i++)add(`Gruppenphase - Spieltag ${i}`,`sched_g_md${i}`,null,'lbl-group');const r=tournamentData.bracket.length;for(let i=0;i<r;i++){const rn=getRoundName(i,r);if(rn==="Finale")continue;if(rn==="Achtelfinale")for(let x=1;x<=8;x++)add(`Achtelfinale ${x}`,`sched_ko_af_${x}`,`sched_ko_r${i}`,'lbl-af',i,x-1);else if(rn==="Viertelfinale")for(let x=1;x<=4;x++)add(`Viertelfinale ${x}`,`sched_ko_vf_${x}`,`sched_ko_r${i}`,'lbl-vf',i,x-1);else if(rn.includes("Halbfinale")){add('Halbfinale 1','sched_sf1',`sched_ko_r${i}`,'lbl-hf',i,0);add('Halbfinale 2','sched_sf2',`sched_ko_r${i}`,'lbl-hf',i,1)}else add(rn,`sched_ko_r${i}`,null,'lbl-af',i)}add('Spiel um Platz 3','sched_third_place',null,'lbl-p3');add('Finale',`sched_ko_r${r-1}`,null,'lbl-final',r-1,0)}else if(m==='release'){add('Qualifikation','sched_rel_qual',null,'lbl-quali');for(let x=1;x<=8;x++)add(`Achtelfinale ${x}`,`sched_rel_af_${x}`,null,'lbl-af',0,x-1);for(let x=1;x<=4;x++)add(`Viertelfinale ${x}`,`sched_rel_vf_${x}`,null,'lbl-vf',1,x-1);add('Halbfinale 1','sched_rel_sf_1',null,'lbl-hf',2,0);add('Halbfinale 2','sched_rel_sf_2',null,'lbl-hf',2,1);add('Spiel um Platz 3','sched_third_place',null,'lbl-p3');add('Finale','sched_rel_final',null,'lbl-final',3,0)}else{const r=tournamentData.bracket.length;for(let i=0;i<r;i++){const rn=getRoundName(i,r);if(rn==="Finale")continue;if(rn==="Achtelfinale")for(let x=1;x<=8;x++)add(`Achtelfinale ${x}`,`sched_ko_af_${x}`,`sched_ko_r${i}`,'lbl-af',i,x-1);else if(rn==="Viertelfinale")for(let x=1;x<=4;x++)add(`Viertelfinale ${x}`,`sched_ko_vf_${x}`,`sched_ko_r${i}`,'lbl-vf',i,x-1);else if(rn.includes("Halbfinale")){add('Halbfinale 1','sched_sf1',`sched_ko_r${i}`,'lbl-hf',i,0);add('Halbfinale 2','sched_sf2',`sched_ko_r${i}`,'lbl-hf',i,1)}else add(rn,`sched_ko_r${i}`,null,'lbl-af',i)}add('Spiel um Platz 3','sched_third_place',null,'lbl-p3');add('Finale',`sched_ko_r${r-1}`,null,'lbl-final',r-1,0)}ct.appendChild(g)}}
function downloadImage(){window.scrollTo(0,0);const target=gID('export-target');const h=target.scrollHeight+100;html2canvas(target,{backgroundColor:'#0f172a',scale:2,scrollX:0,scrollY:0,height:h,useCORS:!0,allowTaint:!0,onclone:(clonedDoc)=>{const images=clonedDoc.getElementById('export-target').querySelectorAll('img');images.forEach(img=>{const rect=img.getBoundingClientRect();if(rect.width>0&&rect.height>0){img.style.width=rect.width+'px';img.style.height=rect.height+'px'}});const ct=clonedDoc.getElementById('export-target');ct.style.height=h+"px"}}).then(c=>{const a=cE('a');a.download='tournament_export.png';a.href=c.toDataURL("image/png");a.click()})}
async function exportToFile(){const d={participants,images:imageRegistry,tournament:tournamentData,theme:document.body.getAttribute('data-theme')};const b=new Blob([JSON.stringify(d)],{type:"application/json"});const dn=`${tournamentData.config.tournamentName||'Turnier'}_${new Date().toISOString().slice(0,10)}`;if(window.showSaveFilePicker){try{const handle=await window.showSaveFilePicker({suggestedName:dn+'.json',types:[{description:'Tournament Data',accept:{'application/json':['.json']}}]});const writable=await handle.createWritable();await writable.write(b);await writable.close();return}catch(err){if(err.name!=='AbortError'){console.error(err);alert('Speichern fehlgeschlagen. Fallback zum Download.')}else{return}}}const u=URL.createObjectURL(b);const f=prompt("Dateiname:",dn);if(!f)return;const a=document.createElement('a');a.href=u;a.download=f.endsWith('.json')?f:f+'.json';a.click()}
function importFromFile(i){const f=i.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{try{const dt=JSON.parse(e.target.result);participants=dt.participants||[];imageRegistry=dt.images||{};tournamentData=dt.tournament||tournamentData;if(!tournamentData.schedule)tournamentData.schedule={start:null,end:null,config:{},phases:{}};if(!tournamentData.schedule.config)tournamentData.schedule.config={};if(!tournamentData.schedule.phases)tournamentData.schedule.phases={};if(!tournamentData.thirdPlace)tournamentData.thirdPlace={p1:null,p2:null,score1:null,score2:null,winnerId:null,completed:!1};if(!tournamentData.schedule.streamerAssignments)tournamentData.schedule.streamerAssignments={};if(dt.theme)d.body.setAttribute('data-theme',dt.theme);gID('tourn-name').value=tournamentData.config.tournamentName||'';gID('header-title').innerText=(tournamentData.config.tournamentName||"TOURNAMENT MANAGER PRO").toUpperCase();renderParticipantList();renderScheduleView();updateUIState();if(tournamentData.active){if(tournamentData.currentStage==='knockout'){switchTab('bracket');renderBracket()}else if(tournamentData.config.mode==='groups_ko'){switchTab('groups');renderGroups()}else if(tournamentData.config.mode==='release'){switchTab('release');renderReleaseView()}else{switchTab('bracket');renderBracket()}}else switchTab('setup');saveData();alert("Geladen!")}catch(x){console.error(x);alert("Fehler!")}};r.readAsText(f)}
function saveData(){try{localStorage.setItem('utm_pro_v4_3',JSON.stringify({participants,images:imageRegistry,tournament:tournamentData,theme:d.body.getAttribute('data-theme')}))}catch(e){}updateExportIfActive()}
function loadData(){const r=localStorage.getItem('utm_pro_v4_3');if(r){try{const dt=JSON.parse(r);imageRegistry=dt.images||{};if(dt.theme)d.body.setAttribute('data-theme',dt.theme);}catch(e){}}loadStreamers()}
function resetTournament(){if(confirm("Reset?")){tournamentData={active:!1,config:{mode:'groups_ko',scoringMode:'matchplay',tournamentName:'Turnier'},groups:[],bracket:[],thirdPlace:{p1:null,p2:null,score1:null,score2:null,winnerId:null,completed:!1},release:{scores:{},relegationScores:{}},schedule:{start:null,end:null,config:{},phases:{},streamerAssignments:{}},bracketBg:null,currentStage:'setup'};gID('tourn-start-date').value='';gID('tourn-end-date').value='';gID('tourn-name').value='';gID('header-title').innerText="TOURNAMENT MANAGER PRO";updateUIState();switchTab('setup');saveData()}}
function simulateGroupMatches(){if(tournamentData.groups.length===0)return;const sp=tournamentData.config.scoringMode==='strokeplay';tournamentData.groups.forEach(g=>{g.matches.forEach(m=>{if(!m.played){if(sp){m.score1=Math.floor(Math.random()*20)-10;m.score2=Math.floor(Math.random()*20)-10}else{m.score1=Math.floor(Math.random()*5);m.score2=Math.floor(Math.random()*5)}m.played=!0}});recalcGroupStats(g)});renderGroups();checkGroupCompletion();saveData()}
function simulateReleaseScores(){if(participants.length===0)return;participants.forEach(p=>{if(!tournamentData.release.scores[p.id])tournamentData.release.scores[p.id]=Math.floor(Math.random()*20)-10});renderReleaseView();saveData()}
function simulateBracketRound(){let f=!1;const sp=(tournamentData.config.mode==='release')||(tournamentData.config.scoringMode==='strokeplay');for(let i=0;i<tournamentData.bracket.length;i++){const ms=tournamentData.bracket[i],rd=ms.filter(m=>m.p1&&m.p2&&!m.completed&&m.p1.indexOf('TBD')===-1&&m.p2.indexOf('TBD')===-1);if(rd.length>0){rd.forEach(m=>{if(sp){m.score1=Math.floor(Math.random()*15)-5;m.score2=Math.floor(Math.random()*15)-5;if(m.score1===m.score2)m.score1-=1}else{m.score1=Math.floor(Math.random()*5);m.score2=Math.floor(Math.random()*5);if(m.score1===m.score2)m.score1+=1}m.winnerId=(sp?(m.score1<m.score2):(m.score1>m.score2))?m.p1:m.p2;m.completed=!0;advanceBracketWinner(i,ms.indexOf(m),m.winnerId)});f=!0;break}}if(!f&&tournamentData.thirdPlace&&tournamentData.thirdPlace.p1&&tournamentData.thirdPlace.p2&&!tournamentData.thirdPlace.completed){const m=tournamentData.thirdPlace;if(sp){m.score1=Math.floor(Math.random()*15)-5;m.score2=Math.floor(Math.random()*15)-5;if(m.score1===m.score2)m.score1-=1}else{m.score1=Math.floor(Math.random()*5);m.score2=Math.floor(Math.random()*5);if(m.score1===m.score2)m.score1+=1}m.winnerId=(sp?(m.score1<m.score2):(m.score1>m.score2))?m.p1:m.p2;m.completed=!0}renderBracket();saveData()}
function handleBracketBackground(i){const f=i.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{tournamentData.bracketBg=e.target.result;saveData();renderBracket()};r.readAsDataURL(f)}
function openStreamerModal(){gID('streamer-modal').style.display='flex';renderStreamerList()}
function closeStreamerModal(){gID('streamer-modal').style.display='none'}
function loadStreamers(){const s=localStorage.getItem('utm_streamers_global');let stored=[];let config={ytLogo:null,twLogo:null};let hasDef=!1;if(s){try{const p=JSON.parse(s);stored=p.list||[];config=p.config||config;hasDef=p.hasDefaults||!1}catch(e){}}const def=[{n:"Holly_Marie VR",p:['yt']},{n:"Eisenseite",p:['tw']},{n:"That_Witch",p:['tw']},{n:"Sun Shine VR",p:['yt','tw']},{n:"K√§ptnDave",p:['tw']},{n:"Handrake",p:['tw']},{n:"Foxy",p:['tw','yt']},{n:"Mandek",p:['tw']},{n:"Thomas Daddelt",p:['yt']}];if(!hasDef){def.forEach((d,i)=>{if(!stored.some(x=>x.name===d.n))stored.push({id:'def_s_'+i,name:d.n,img:null,platforms:d.p})});hasDef=!0}streamers=stored;streamerConfig=config;saveStreamerSettings()}
function saveStreamerSettings(){localStorage.setItem('utm_streamers_global',JSON.stringify({list:streamers,config:streamerConfig,hasDefaults:!0}));updateExportIfActive()}
function addStreamer(){const n=gID('new-streamer-name').value.trim();if(!n)return;streamers.push({id:'s_'+Date.now(),name:n,img:null,platforms:[]});gID('new-streamer-name').value='';renderStreamerList()}
function handleStreamerTextUpload(i){const f=i.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{const l=e.target.result.split(/\r?\n/);let c=0;l.forEach(x=>{const n=x.trim();if(n){streamers.push({id:'s_'+Date.now()+Math.random(),name:n,img:null,platforms:[]});c++}});renderStreamerList();if(c)alert(c+" Streamer importiert!");i.value=''};r.readAsText(f)}
function handlePlatformLogoUpload(t,i){const f=i.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{if(t==='yt')streamerConfig.ytLogo=e.target.result;else streamerConfig.twLogo=e.target.result;renderStreamerList()};r.readAsDataURL(f)}
function renderStreamerList(){const c=gID('streamer-list');c.innerHTML='';streamers.forEach(s=>{const d=cE('div');d.className='streamer-card';d.innerHTML=`<label class="p-img-wrapper" style="width:40px;height:40px"><img src="${s.img||D_IMG}" class="streamer-img"><input type="file" accept="image/*" style="display:none;" onchange="updateStreamerImg('${s.id}',this)"><div class="p-img-edit-overlay">‚úèÔ∏è</div></label><input type="text" value="${s.name}" onchange="updateStreamerName('${s.id}',this.value)" class="streamer-name-input"><div class="platform-toggle ${s.platforms.includes('yt')?'active':''}" onclick="togglePlatform('${s.id}','yt')"><img src="${streamerConfig.ytLogo||D_YT}" style="width:24px;height:24px"></div><div class="platform-toggle ${s.platforms.includes('tw')?'active':''}" onclick="togglePlatform('${s.id}','tw')"><img src="${streamerConfig.twLogo||D_TW}" style="width:24px;height:24px"></div><button onclick="deleteStreamer('${s.id}')" style="background:none;border:none;color:var(--danger);cursor:pointer">‚úñ</button>`;c.appendChild(d)})}
function updateStreamerImg(id,inp){const f=inp.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{const s=streamers.find(x=>x.id===id);if(s){s.img=e.target.result;renderStreamerList()}};r.readAsDataURL(f)}
function updateStreamerName(id,val){const s=streamers.find(x=>x.id===id);if(s)s.name=val}
function togglePlatform(id,p){const s=streamers.find(x=>x.id===id);if(s){if(s.platforms.includes(p))s.platforms=s.platforms.filter(x=>x!==p);else s.platforms.push(p);renderStreamerList()}}
function deleteStreamer(id){streamers=streamers.filter(s=>s.id!==id);renderStreamerList()}
const st=cE('style');st.innerHTML=`@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, .7); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }`;d.head.appendChild(st);</script></body></html>